---
title: "pbmc_final_revise"
author: "Hongxu Zhu"
always_allow_html: yes
date: "`r Sys.Date()`"
output:
  html_document:
    theme: united
    toc: yes
    toc_collapsed: yes
    toc_float: yes
---

```{r alternative-preambles,echo=FALSE,include=FALSE,eval=FALSE}
## if using word replace output with
output:
  word_document:
    toc: yes

## if using pdf replace output with
output:
  pdf_document:
    toc: yes
header-includes:
  - \usepackage{xcolor}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

## colorizes text when using html or pdf output
## just spits out text x for word
colorize <- function(x, color) {
  if(color=="todo"){
    color <- "red"
    x <- paste0("TODO: ",x)
  }
  if (knitr::is_latex_output()) {
    sprintf("\\textcolor{%s}{%s}", color, x)
  } else if (knitr::is_html_output()) {
    sprintf("<span style='color: %s;'>%s</span>", color, 
      x)
  } else x
}

todo <- function(x){
  paste0("**",colorize(x,"todo"),"**")
}

library(kableExtra)
library(cmapR)
library(edgeR)
```

This file contains the full analysis pipeline on Kang et. al 2018 PBMC purterbation dataset. The Total cell type is 7, 6998 genes are measured and the conditions are "control" and "stimulated".

## Preprocessing

### Input Data Set

```{r}
## input full data set
kang_obs <- read.csv("data/kang_obs.csv")
kang_var <- read.csv("data/kang_var.csv")
kang_X <- read.csv("data/kang_X.csv",header=FALSE)
names(kang_X) <- kang_var$gene_symbol
```

```{r}
####### Get control and stimulated data
ctype <- unique(kang_obs$cell_type)
kang_ctr <- list()
kang_sti <- list()
for (i in 1:length(ctype)){
  kang_ctr[[i]] <- kang_X[kang_obs$condition=="control" & kang_obs$cell_type==ctype[i],]
  kang_sti[[i]] <- kang_X[kang_obs$condition=="stimulated" & kang_obs$cell_type==ctype[i],]
}
ctname <- c("NK","Dendritic","CD4T","B","FCGR3A","CD14","CD8T")
names(kang_ctr) <- ctname
names(kang_sti) <- ctname

kang_ctr_m <- list()
kang_sti_m <- list()
for (i in 1:length(ctype)){
  kang_ctr_m[[i]] <- apply(kang_ctr[[i]], 2, mean)
  kang_sti_m[[i]] <- apply(kang_sti[[i]], 2, mean)
}

names(kang_ctr_m) <- ctname
names(kang_sti_m) <- ctname
```

```{r}
genes <- kang_var$gene_symbol
```

## Differential Gene analysis on observed data

```{r}
DEG_obs <- list()
tables <- list()
keeps <- list()
for (i in 1: length(ctype)){
  temp <- kang_X[kang_obs$cell_type==ctype[i],]
  counts <- t(temp)
  keeps[[i]] <- rownames(counts)
  condition <- kang_obs$condition[kang_obs$cell_type==ctype[i]]
  design <- model.matrix(~condition)
  fit <- lmFit(counts,design)
  fit <- eBayes(fit)
  top.table <- topTable(fit,sort.by = "logFC", n = Inf)
  tables[[i]] <- top.table
  DE_new <- data.frame(rownames(top.table),top.table$logFC,top.table$adj.P.Val,top.table$B)
  names(DE_new) <- c("gene","logfc","adj.P.val","log-odds")
  DEG_obs[[i]] <- DE_new
}
names(DEG_obs) <- names(kang_ctr)
names(tables) <- names(kang_ctr)
names(keeps) <- names(kang_ctr)

p_lvl <- 0.00001
lfc <- 0.3

DEG_genes_obs <- list()
for (i in 1: length(ctype)){
  temp <- DEG_obs[[i]]$gene[DEG_obs[[i]]$adj.P.val<p_lvl & abs(DEG_obs[[i]]$logfc)>lfc]
  DEG_genes_obs[[i]] <- temp
}
names(DEG_genes_obs) <- names(kang_ctr)
```

## Get Predictions

### Get scGen Predictions

```{r}
paths <- c("scgen_result/pred_NK.csv","scgen_result/pred_Dendritic.csv","scgen_result/pred_CD4T.csv","scgen_result/pred_B.csv","scgen_result/pred_FCGR3A.csv","scgen_result/pred_CD14.csv","scgen_result/pred_CD8T.csv")
scgen_pred <- list()
for (i in 1: length(ctype)){
  temp <- read.csv(paths[i])
  temp <- temp[,-1]
  scgen_pred[[i]] <- temp
  names(scgen_pred[[i]]) <- genes
}
names(scgen_pred) <- names(kang_ctr)

scgen_pred_m <- list()
for (i in 1: length(ctype)){
  temp <- apply(scgen_pred[[i]], 2, mean)
  names(temp) <- genes
  scgen_pred_m[[i]] <- temp
}
```

### Get Cell Type Predictions

```{r}
fit <- lm(as.matrix(kang_X) ~ kang_obs$cell_type, x=TRUE)

ct_pred <- list()
for (i in 1: length(ctype)){
  ix <- kang_obs$condition=="stimulated" & kang_obs$cell_type==ctype[i]
  obs_test <- fit$x[ix,]
  obs_train <- fit$x[!ix,]

  X_test <-as.matrix(kang_X[ix,]) 
  X_train <- as.matrix(kang_X[!ix,])

  fit.x <- lm.fit(obs_train,X_train)
  pred_ct <- obs_test%*%fit.x$coefficients
  names(pred_ct) <- genes
  ct_pred[[i]] <- pred_ct[1,]
}
names(ct_pred) <- names(kang_ctr)
```

### Get Two-factor Predictions

```{r}
fit <- lm(as.matrix(kang_X) ~ kang_obs$cell_type+kang_obs$condition, x=TRUE)

tf_pred <- list()
pval_tf <- list()
for (i in 1: length(ctype)){
  ix <- kang_obs$condition=="stimulated" & kang_obs$cell_type==ctype[i]
  obs_test <- fit$x[ix,]
  obs_train <- fit$x[!ix,]

  X_test <-as.matrix(kang_X[ix,]) 
  X_train <- as.matrix(kang_X[!ix,])

  fit.x <- lm.fit(obs_train,X_train)
  pred_tf <- obs_test%*%fit.x$coefficients
  names(pred_tf) <- genes
  tf_pred[[i]] <- pred_tf[1,]
  ### get p-values
  rss <- c()
  for (j in 1:ncol(fit.x$residuals)){
    rss[j] <- sum(fit.x$residuals[,j]^2)
  }
  rdf <- nrow(X_train)-ncol(obs_train)
  resvar <- rss/rdf
  R <- chol2inv(fit.x$qr$qr)
  se <- list()
  for (j in 1: ncol(fit.x$residuals)){
    se[[j]] <- sqrt(diag(R)*resvar[j])
  }
  pval <- c()
  for (j in 1: ncol(fit.x$residuals)){
    pval[j] <- 2*pt(abs(fit.x$coefficients[,j]/se[[j]]),rdf,lower.tail = FALSE)[8]
  } 
  pval_tf[[i]] <- pval
}

names(tf_pred) <- names(kang_ctr)

### p-value calculation


```

## Compute R2 For every cell type using 3 methods

### scGen R2

```{r}
library(ggplot2)
R2_scgen <- c()
R2_DE_scgen <-c()
for (i in 1: length(ctype)){
  status <- rep("nosig", length(genes))
  status[which(genes %in% DEG_genes_obs[[i]])] <- "sig"
  observation <- kang_sti_m[[i]]
  prediction <- scgen_pred_m[[i]]
  dt <- data.frame(genes,observation,prediction,status)
  names(dt) <- c("genes", "observation", "prediction", "status")
  R2_scgen[i] <- round(cor(as.numeric(kang_sti_m[[i]]),as.numeric(scgen_pred_m[[i]]))^2,2)
  R2_DE_scgen[i] <- round(cor(as.numeric(kang_sti_m[[i]][status=="sig"]),as.numeric(scgen_pred_m[[i]][status=="sig"]))^2,2)
  
  p <- ggplot(dt, aes(x=observation, y=prediction, color=status)) + 
  geom_point(shape=2,alpha=0.8)+
  geom_smooth(method=lm, na.rm = TRUE,colour="black")+
  scale_colour_manual(name="status", values=c("blue","red"))+
  xlab("observation") + ylab("Prediction")+ ggtitle(ctype[[i]])+
  labs(tag = paste0("R2=",R2_scgen[i]))+ theme(plot.tag.position = "topright")
  print(p)
}

names(R2_scgen) <- ctname
names(R2_DE_scgen) <- ctname
```

### Cell Type R2 

```{r}
R2_ct <- c()
R2_DE_ct <-c()
for (i in 1: length(ctype)){
  status <- rep("nosig", length(genes))
  status[which(genes %in% DEG_genes_obs[[i]])] <- "sig"
  observation <- kang_sti_m[[i]]
  prediction <- ct_pred[[i]]
  dt <- data.frame(genes,observation,prediction,status)
  names(dt) <- c("genes", "observation", "prediction", "status")
  R2_ct[i] <- round(cor(as.numeric(kang_sti_m[[i]]),as.numeric(ct_pred[[i]]))^2,2)
  R2_DE_ct[i] <- round(cor(as.numeric(kang_sti_m[[i]][status=="sig"]),as.numeric(ct_pred[[i]][status=="sig"]))^2,2)
  
  p <- ggplot(dt, aes(x=observation, y=prediction, color=status)) + 
  geom_point(shape=2,alpha=0.8)+
  geom_smooth(method=lm, na.rm = TRUE,colour="black")+
  scale_colour_manual(name="status", values=c("blue","red"))+
  xlab("observation") + ylab("Prediction")+ ggtitle(ctype[[i]])+
  labs(tag = paste0("R2=",R2_ct[i]))+ theme(plot.tag.position = "topright")
  print(p)
}

names(R2_ct) <- ctname
names(R2_DE_ct) <- ctname
```

### Two-factor R2 

```{r}
R2_tf <- c()
R2_DE_tf <-c()
for (i in 1: length(ctype)){
  status <- rep("nosig", length(genes))
  status[which(genes %in% DEG_genes_obs[[i]])] <- "sig"
  observation <- kang_sti_m[[i]]
  prediction <- tf_pred[[i]]
  dt <- data.frame(genes,observation,prediction,status)
  names(dt) <- c("genes", "observation", "prediction", "status")
  R2_tf[i] <- round(cor(as.numeric(kang_sti_m[[i]]),as.numeric(tf_pred[[i]]))^2,2)
  R2_DE_tf[i] <- round(cor(as.numeric(kang_sti_m[[i]][status=="sig"]),as.numeric(tf_pred[[i]][status=="sig"]))^2,2)
  
  p <- ggplot(dt, aes(x=observation, y=prediction, color=status)) + 
  geom_point(shape=2,alpha=0.8)+
  geom_smooth(method=lm, na.rm = TRUE,colour="black")+
  scale_colour_manual(name="status", values=c("blue","red"))+
  xlab("observation") + ylab("Prediction")+ ggtitle(ctype[[i]])+
  labs(tag = paste0("R2=",R2_tf[i]))+ theme(plot.tag.position = "topright")
  print(p)
}

names(R2_tf) <- ctname
names(R2_DE_tf) <- ctname
```

## Generate samples from Cell type model and two-factor model

### Cell type model

For cell type model, the prediction mean is the same as the control mean for each cell type. So the cell type prediction should be the same as the control distribution.

```{r}
ct_dist <- kang_ctr
names(ct_dist) <- ctname
```

### Two-factor model

```{r}
tf_dist <- list()
for (i in 1: length(ctype)){
  ctr <- kang_ctr[[i]]
  df <- tf_pred[[i]]-kang_ctr_m[[i]]
  temp <- ctr
  for (j in 1:ncol(ctr)){
    temp[,j] <- ctr[,j]+df[j]
  }
  tf_dist[[i]] <- temp
}
names(tf_dist) <- ctname
```

## Violin Plots for selected cell types

### CD4T DE genes

```{r}
for (id in 1: length(DEG_genes_obs[[3]])){
  test_scgen <- scgen_pred[[3]][,genes==DEG_genes_obs[[3]][id]]
  test_ctr <- kang_ctr[[3]][,genes==DEG_genes_obs[[3]][id]]
  test_sti <- kang_sti[[3]][,genes==DEG_genes_obs[[3]][id]]
  test_ct <- ct_dist[[3]][,genes==DEG_genes_obs[[3]][id]]
  test_tf <- tf_dist[[3]][,genes==DEG_genes_obs[[3]][id]]

  method1 <- rep("control",length(test_ctr))
  method2 <- rep("stimulated", length(test_sti))
  method3 <- rep("two-factor", length(test_tf))
  method4 <- rep("scgen", length(test_scgen))
  method5 <- rep("cell type", length(test_ct))
  method <- c(method1,method2,method3,method4,method5)
  res <- c(test_ctr,test_sti,test_tf,test_scgen,test_ct)
  d <- data.frame(res,method)
  names(d) <- c("R2", "method")

  level_order <- c("control","stimulated","cell type","two-factor","scgen")
  p <- ggplot(d, aes(x=factor(method,level=level_order), y=R2, fill=method)) + 
    geom_violin() +geom_boxplot(width=0.1) +
    labs(x="Condition",
         y=paste0("expression for ",DEG_genes_obs[[3]][id]))
  print(p)
}
```

### CD4T non DE genes

```{r}
CD4T_sub_genes <- genes[which(!(genes %in% DEG_genes_obs[[3]]))][1:60]
for (id in 1: length(DEG_genes_obs[[3]])){
  test_scgen <- scgen_pred[[3]][,genes==CD4T_sub_genes[id]]
  test_ctr <- kang_ctr[[3]][,genes==CD4T_sub_genes[id]]
  test_sti <- kang_sti[[3]][,genes==CD4T_sub_genes[id]]
  test_ct <- ct_dist[[3]][,genes==CD4T_sub_genes[id]]
  test_tf <- tf_dist[[3]][,genes==CD4T_sub_genes[id]]

  method1 <- rep("control",length(test_ctr))
  method2 <- rep("stimulated", length(test_sti))
  method3 <- rep("two-factor", length(test_tf))
  method4 <- rep("scgen", length(test_scgen))
  method5 <- rep("cell type", length(test_ct))
  method <- c(method1,method2,method3,method4,method5)
  res <- c(test_ctr,test_sti,test_tf,test_scgen,test_ct)
  d <- data.frame(res,method)
  names(d) <- c("R2", "method")

  level_order <- c("control","stimulated","cell type","two-factor","scgen")
  p <- ggplot(d, aes(x=factor(method,level=level_order), y=R2, fill=method)) + 
    geom_violin() +geom_boxplot(width=0.1) +
    labs(x="Condition",
         y=paste0("expression for ",CD4T_sub_genes[id]))
  print(p)
}
```

### CD14 DE genes

```{r}
for (id in 1: length(DEG_genes_obs[[6]])){
  test_scgen <- scgen_pred[[6]][,genes==DEG_genes_obs[[6]][id]]
  test_ctr <- kang_ctr[[6]][,genes==DEG_genes_obs[[6]][id]]
  test_sti <- kang_sti[[6]][,genes==DEG_genes_obs[[6]][id]]
  test_ct <- ct_dist[[6]][,genes==DEG_genes_obs[[6]][id]]
  test_tf <- tf_dist[[6]][,genes==DEG_genes_obs[[6]][id]]

  method1 <- rep("control",length(test_ctr))
  method2 <- rep("stimulated", length(test_sti))
  method3 <- rep("two-factor", length(test_tf))
  method4 <- rep("scgen", length(test_scgen))
  method5 <- rep("cell type", length(test_ct))
  method <- c(method1,method2,method3,method4,method5)
  res <- c(test_ctr,test_sti,test_tf,test_scgen,test_ct)
  d <- data.frame(res,method)
  names(d) <- c("R2", "method")

  level_order <- c("control","stimulated","cell type","two-factor","scgen")
  p <- ggplot(d, aes(x=factor(method,level=level_order), y=R2, fill=method)) + 
    geom_violin() +geom_boxplot(width=0.1) +
    labs(x="Condition",
         y=paste0("expression for ",DEG_genes_obs[[6]][id]))
  print(p)
}
```


## Volcano Plots

### Volcano Plots on Observed Data

```{r, fig.height=5}
library(EnhancedVolcano)

v_list_obs <- list()

for (i in 1: length(ctype)){
  v_list_obs[[i]] <- EnhancedVolcano(tables[[i]],
                 lab = keeps[[i]],
                 title = ctype[i],
                 x = 'logFC',
                 y = 'adj.P.Val',
                 pCutoff=1e-10,
                 FCcutoff = 0.3)
  print(v_list_obs[[i]])
}

names(v_list_obs[[i]]) <- ctype
```

### Volcano plots using predictions

Need to conduct DEG on predictions

#### DEG two-factor model

```{r}
DEG_tf <- list()
tables_tf <- list()
keeps_tf <- list()
for (i in 1: length(ctype)){
  temp <- data.frame(rbind(kang_ctr[[i]],tf_dist[[i]]))
  counts <- t(temp)
  keeps_tf[[i]] <- rownames(counts)
  condition <- c(rep("control",nrow(kang_ctr[[i]])),rep("prediction",nrow(tf_dist[[i]])))
  design <- model.matrix(~condition)
  fit <- lmFit(counts,design)
  fit <- eBayes(fit)
  top.table <- topTable(fit,sort.by = "logFC", n = Inf)
  tables_tf[[i]] <- top.table
  DE_tf_new <- data.frame(rownames(top.table),top.table$logFC,top.table$adj.P.Val,top.table$B)
  names(DE_tf_new) <- c("gene","logfc","adj.P.val","log-odds")
  DEG_tf[[i]] <- DE_tf_new
}
names(DEG_tf) <- names(kang_ctr)
names(tables_tf) <- names(kang_ctr)
names(keeps_tf) <- names(kang_ctr)

pval_tf_keep <- list()
for (i in 1:length(ctype)){
  pval_tf_keep[[i]] <- data.frame(pval_tf[[i]][rownames(counts) %in% keeps_tf[[i]]],keeps_tf[[i]])
  names(pval_tf_keep[[i]]) <- c("pval", "gene")
  rownames(pval_tf_keep[[i]]) <- keeps_tf[[i]]
}

tables_tf_new <- list()
for (i in 1: length(ctype)){
  tables_tf_new[[i]] <- merge(tables_tf[[i]],pval_tf_keep[[i]],by=0)
  DEG_tf[[i]] <- merge(DEG_tf[[i]],pval_tf_keep[[i]],by="gene")
}


p_lvl <- 0.00001
lfc <- 0.3

DEG_genes_tf <- list()
for (i in 1: length(ctype)){
  temp <- DEG_tf[[i]]$gene[DEG_tf[[i]]$pval<p_lvl & abs(DEG_tf[[i]]$logfc)>lfc]
  DEG_genes_tf[[i]] <- temp
}
names(DEG_genes_tf) <- names(kang_ctr)
```

#### Volcano Plots two-factor

```{r, fig.height=5}
for (i in 1: length(ctype)){
  v <- EnhancedVolcano(tables_tf_new[[i]],
       lab = keeps_tf[[i]],
       x = 'logFC',
       y = 'pval',
       pCutoff=1e-5,
       FCcutoff = 0.3)
  print(v)
}

```

#### DEG scgen prediction

```{r}
DEG_scgen <- list()
tables_scgen <- list()
keeps_scgen <- list()
for (i in 1: length(ctype)){
  temp <- data.frame(rbind(kang_ctr[[i]],scgen_pred[[i]]))
  counts <- t(temp)
  keeps_scgen[[i]] <- rownames(counts)
  condition <- c(rep("control",nrow(kang_ctr[[i]])),rep("prediction",nrow(scgen_pred[[i]])))
  design <- model.matrix(~condition)
  fit <- lmFit(counts,design)
  fit <- eBayes(fit)
  top.table <- topTable(fit,sort.by = "logFC", n = Inf)
  tables_scgen[[i]] <- top.table
  DE_scgen_new <- data.frame(rownames(top.table),top.table$logFC,top.table$adj.P.Val,top.table$B)
  names(DE_scgen_new) <- c("gene","logfc","adj.P.val","log-odds")
  DEG_scgen[[i]] <- DE_scgen_new
}
names(DEG_scgen) <- names(kang_ctr)
names(tables_scgen) <- names(kang_ctr)
names(keeps_scgen) <- names(kang_ctr)

p_lvl <- 0.00001
lfc <- 0.3

DEG_genes_scgen <- list()
for (i in 1: length(ctype)){
  temp <- DEG_scgen[[i]]$gene[DEG_scgen[[i]]$adj.P.val<p_lvl & abs(DEG_scgen[[i]]$logfc)>lfc]
  DEG_genes_scgen[[i]] <- temp
}
names(DEG_genes_scgen) <- names(kang_ctr)
```

#### Volcano Plots scgen

```{r, fig.height=5}
for (i in 1: length(ctype)){
  v <- EnhancedVolcano(tables_scgen[[i]],
       lab = keeps_scgen[[i]],
       x = 'logFC',
       y = 'adj.P.Val',
       pCutoff=1e-10,
       FCcutoff = 0.3)
  print(v)
}
```



## Evaluating prediction using ROC

### Method 1: scoring based on log fold change

```{r}
score_scgen <- list()
score_ct <- list()
score_tf <- list()
for (i in 1: length(ctype)){
  score_scgen[[i]] <- rep(0,length(genes))
  score_ct[[i]] <- rep(0,length(genes))
  score_tf[[i]] <- rep(0,length(genes))
  test1 <- tables_scgen[[i]]
  test1.re <- test1[order(match(rownames(test1),keeps_scgen[[i]])),]
  score_scgen[[i]][which(rownames(counts) %in% keeps_scgen[[i]])] <- abs(test1.re$logFC)
  test2 <- tables_tf[[i]]
  test2.re <- test2[order(match(rownames(test2),keeps_tf[[i]])),]
  score_tf[[i]][which(rownames(counts) %in% keeps_tf[[i]])] <- abs(test2.re$logFC)
}

names(score_scgen) <- ctname
names(score_ct) <- ctname
names(score_tf) <- ctname
```

### ROC curves

```{r}
library(pROC)
auc_scgen <- c()
auc_tf <- c()
auc_ct <- c()
for (i in 1: length(ctype)){
  dt <- data.frame(t(rep(0,length(genes))))
  names(dt) <- rownames(counts)
  dt[which(rownames(counts) %in% DEG_genes_obs[[i]])] <- 1
  dt <- t(dt)
  pred1 <- as.numeric(score_scgen[[i]])
  pred2 <- as.numeric(score_ct[[i]])
  pred3 <- as.numeric(score_tf[[i]])
  sim_roc1 <- roc(response = as.vector(dt),
                 predictor = pred1,
                 levels = c(0,1))
  sim_roc2 <- roc(response = as.vector(dt),
                 predictor = rep(0,length(pred2)),
                 levels = c(0,1))
  sim_roc3 <- roc(response = as.vector(dt),
                 predictor = pred3,
                 levels = c(0,1))
  auc_scgen[i] <- auc(sim_roc1)
  auc_ct[i] <- auc(sim_roc2)
  auc_tf[i] <- auc(sim_roc3)
  pred_names <- c("scgen","cell type","two factor")
  touse <- list(sim_roc1,sim_roc2,sim_roc3)
  names(touse) <- pred_names
  g2 <- ggroc(touse)
  g2 <- g2 + xlab("Specificity (# Predicted non-DE gene / # True non-DE gene)") + ylab("Sensitivity (# Predicted DE   gene / # True DE gene)")
  print(g2)
}
```

## Other metrics for evaluating prediction results

### Confusion Matrices

```{r}
library(caret)
scgen_cfm <- list()
tf_cfm <- list()
for (i in 1: length(ctype)){
  true <- rep(0,length(genes))
  true[which(genes %in% DEG_genes_obs[[i]])] <- 1
  tf <- rep(0,length(genes))
  tf[which(genes %in% DEG_genes_tf[[i]])] <- 1
  scgen <- rep(0,length(genes))
  scgen[which(genes %in% DEG_genes_scgen[[i]])] <- 1
  scgen_cfm[[i]] <- confusionMatrix(data=as.factor(scgen), reference = as.factor(true), positive="1")
  tf_cfm[[i]] <- confusionMatrix(data=as.factor(tf), reference = as.factor(true), positive="1")
}
names(scgen_cfm) <- ctname
names(tf_cfm) <- ctname
```

### scatter plot: true logfc vs predicted logfc

#### scGen

```{r}
dt_scgen_list <- list()
for (i in 1: length(ctype)){
  tr.lfc <- rep(0,length(genes))
  test <- tables[[i]]
  test.re <- test[order(match(rownames(test),keeps[[i]])),] 
  tr.lfc[which(genes %in% keeps[[i]])] <- test.re$logFC
  scgen.lfc <- rep(0,length(genes))
  test1 <- tables_scgen[[i]]
  test1.re <- test1[order(match(rownames(test1),keeps_scgen[[i]])),]
  scgen.lfc[which(rownames(counts) %in% keeps_scgen[[i]])] <- test1.re$logFC
  
  status <- rep("nosig", length(genes))
  status[which(genes %in% DEG_genes_obs[[i]] & genes %in% DEG_genes_scgen[[i]])] <- "True positive"
  status[which(genes %in% DEG_genes_obs[[i]] & !(genes %in% DEG_genes_scgen[[i]]))] <- "False negative"
  status[which(!(genes %in% DEG_genes_obs[[i]]) & genes %in% DEG_genes_scgen[[i]])] <- "False positive"
  status[which(!(genes %in% DEG_genes_obs[[i]]) & !(genes %in% DEG_genes_scgen[[i]]))] <- "True negative"
  dt <- data.frame(genes,tr.lfc,scgen.lfc,status)
  names(dt) <- c("genes", "observation", "prediction", "status")
  dt_scgen_list[[i]] <- dt
  
  p <- ggplot(dt, aes(x=observation, y=prediction, color=status)) + 
  geom_point(shape=1,alpha=0.8)+
  geom_hline(yintercept=0.3, linetype="dashed", color = "black")+
  geom_hline(yintercept=-0.3, linetype="dashed", color = "black")+
  geom_vline(xintercept=0.3, linetype="dashed", color = "black")+
  geom_vline(xintercept=-0.3, linetype="dashed", color = "black")+
  xlab("True Logfc") + ylab("Predicted Logfc")+ ggtitle(ctype[[i]])+
  theme(plot.tag.position = "topright")
  print(p)
}
```

#### Two-factor

```{r}
dt_tf_list <- list()
for (i in 1: length(ctype)){
  tr.lfc <- rep(0,length(genes))
  test <- tables[[i]]
  test.re <- test[order(match(rownames(test),keeps[[i]])),] 
  tr.lfc[which(genes %in% keeps[[i]])] <- test.re$logFC
  tf.lfc <- rep(0,length(genes))
  test1 <- tables_tf[[i]]
  test1.re <- test1[order(match(rownames(test1),keeps_tf[[i]])),]
  tf.lfc[which(rownames(counts) %in% keeps_tf[[i]])] <- test1.re$logFC
  
  status <- rep("nosig", length(genes))
  status[which(genes %in% DEG_genes_obs[[i]] & genes %in% DEG_genes_tf[[i]])] <- "True positive"
  status[which(genes %in% DEG_genes_obs[[i]] & !(genes %in% DEG_genes_tf[[i]]))] <- "False negative"
  status[which(!(genes %in% DEG_genes_obs[[i]]) & genes %in% DEG_genes_tf[[i]])] <- "False positive"
  status[which(!(genes %in% DEG_genes_obs[[i]]) & !(genes %in% DEG_genes_tf[[i]]))] <- "True negative"
  dt <- data.frame(genes,tr.lfc,tf.lfc,status)
  names(dt) <- c("genes", "observation", "prediction", "status")
  dt_tf_list[[i]] <- dt
  
  p <- ggplot(dt, aes(x=observation, y=prediction, color=status)) + 
  geom_point(shape=1,alpha=0.8)+
  geom_hline(yintercept=0.3, linetype="dashed", color = "black")+
  geom_hline(yintercept=-0.3, linetype="dashed", color = "black")+
  geom_vline(xintercept=0.3, linetype="dashed", color = "black")+
  geom_vline(xintercept=-0.3, linetype="dashed", color = "black")+
  xlab("True Logfc") + ylab("Predicted Logfc")+ ggtitle(ctype[[i]])+
  theme(plot.tag.position = "topright")
  print(p)
}
```

### Precision-Recall curve

```{r}
library(yardstick)
library(dplyr)
pr_auc_scgen <- list()
pr_auc_tf <- list()
pr_curve <- list()
for (i in 1: length(ctype)){
  true <- rep(0,length(genes))
  true[which(genes %in% DEG_genes_obs[[i]])] <- 1
  dt <- data.frame(as.factor(true),score_scgen[[i]])
  names(dt) <- c("true","score")
  dt2 <- data.frame(as.factor(true),score_tf[[i]])
  names(dt2) <- c("true","score")
  dtf <- rbind(dt,dt2)
  method <- c(rep("scgen",nrow(dt)),rep("two-factor",nrow(dt2)))
  dtf <- data.frame(dtf,method)
  pr_auc_scgen[[i]] <- pr_auc(dt, true, score, event_level = "second")
  pr_auc_tf[[i]] <- pr_auc(dt2, true, score, event_level = "second")
  pr_curve[[i]] <- dtf %>%
         group_by(method) %>%
         pr_curve(true, score, event_level = "second") %>%
         ggplot(aes(x = recall, y = precision, color=method)) +
         geom_path() +
         coord_equal() +
         theme_bw()+
         ggtitle(ctype[[i]])
         print(pr_curve[[i]])
}
```

### Compare True DE genes and Predicted DE genes

```{r}
tp_genes_scgen <- list()
tp_genes_tf <- list()
for (i in 1:length(ctype)){
  tp_genes_scgen[[i]] <- intersect(DEG_genes_obs[[i]],DEG_genes_scgen[[i]])
  tp_genes_tf[[i]] <- intersect(DEG_genes_obs[[i]],DEG_genes_tf[[i]])
}
```

### Genes differentially expressed across all cell types

```{r}
int_genes <- Reduce(intersect, list(DEG_genes_obs[[1]],DEG_genes_obs[[2]],DEG_genes_obs[[3]],DEG_genes_obs[[4]],DEG_genes_obs[[5]],DEG_genes_obs[[6]],DEG_genes_obs[[7]]))
```

#### Can scgen and two-factor model correctly predict those genes?

```{r}
tpsub_genes_scgen <- list()
tpsub_genes_tf <- list()
for (i in 1:length(ctype)){
  tpsub_genes_scgen[[i]] <- intersect(int_genes,DEG_genes_scgen[[i]])
  tpsub_genes_tf[[i]] <- intersect(int_genes,DEG_genes_tf[[i]])
}
```

Two factor model can successfully predict those DE genes.

### Cell type specific DE genes

```{r}
cts_genes <- list()
for (i in 1:length(ctype)){
  cts_genes[[i]] <- DEG_genes_obs[[i]][!DEG_genes_obs[[i]] %in% int_genes]
}
```

#### Compare the performance of predicting cell type specific DE Genes

```{r}
cts_genes_scgen <- list()
cts_genes_tf <- list()
for (i in 1:length(ctype)){
  cts_genes_scgen[[i]] <- intersect(cts_genes[[i]],DEG_genes_scgen[[i]])
  cts_genes_tf[[i]] <- intersect(cts_genes[[i]],DEG_genes_tf[[i]])
}
```

### Precision recall curve with current threshold

```{r}
for (i in 1: length(ctype)){
  true <- rep(0,length(genes))
  true[which(genes %in% DEG_genes_obs[[i]])] <- 1
  dt <- data.frame(as.factor(true),score_scgen[[i]])
  names(dt) <- c("true","score")
  dt2 <- data.frame(as.factor(true),score_tf[[i]])
  names(dt2) <- c("true","score")
  dtf <- rbind(dt,dt2)
  method <- c(rep("scgen",nrow(dt)),rep("two-factor",nrow(dt2)))
  dtf <- data.frame(dtf,method)
  pr_auc_scgen[[i]] <- pr_auc(dt, true, score, event_level = "second")
  pr_auc_tf[[i]] <- pr_auc(dt2, true, score, event_level = "second")
  p <- dtf %>%
         group_by(method) %>%
         pr_curve(true, score, event_level = "second") %>%
         ggplot(aes(x = recall, y = precision, color=method)) +
         geom_vline(xintercept = length(tp_genes_scgen[[i]])/length(DEG_genes_obs[[i]]),color="red",linetype="dashed")+
         geom_vline(xintercept = length(tp_genes_tf[[i]])/length(DEG_genes_obs[[i]]),color="light blue",linetype="dashed")+
         geom_path() +
         coord_equal() +
         theme_bw()+
         ggtitle(ctype[[i]])
         print(p)
}
```

```{r}
intersect_all <- function(a,b,...){
  Reduce(intersect, list(a,b,...))
}

intersect_all(DEG_genes_obs[[1]],DEG_genes_obs[[2]],DEG_genes_obs[[3]],DEG_genes_obs[[4]],DEG_genes_obs[[5]],DEG_genes_obs[[6]],DEG_genes_obs[[7]])
```

## Get plots for CD4T

### Compare R2

```{r}
  status <- rep("non DE", length(genes))
  status[which(genes %in% DEG_genes_obs[[3]])] <- "DE"
  observation <- kang_sti_m[[3]]
  prediction <- tf_pred[[3]]
  dt_r2_tf <- data.frame(genes,observation,prediction,status)
  names(dt_r2_tf) <- c("genes", "observation", "prediction", "status")
  
  observation <- kang_sti_m[[3]]
  prediction <- scgen_pred_m[[3]]
  dt_r2_scgen <- data.frame(genes,observation,prediction,status)
  names(dt_r2_scgen) <- c("genes", "observation", "prediction", "status")
  
  dt_r2 <- data.frame(rbind(dt_r2_scgen,dt_r2_tf))
  method <- c(rep("scgen",nrow(dt_r2_scgen)),rep("two-factor",nrow(dt_r2_tf)))
  dt_r2 <- data.frame(dt_r2,method)
  
  
  labs <- c(paste0("scgen, R2=",R2_scgen[3]),paste0("two-factor, R2=",R2_tf[3]))
  names(labs) <- c("Scgen","Two-factor")
  p_r2 <- ggplot(dt_r2, aes(x=prediction, y=observation, color=status)) + 
  geom_point()+
  geom_smooth(method=lm, na.rm = TRUE,colour="black")+
  scale_colour_manual(name="status", values=c("red","blue"))+
  xlab("predicted stimulated expressions") + ylab("In vitro stimulated expressions")+facet_wrap(~method,nrow = 1,labeller = labeller(method=labs))+theme(strip.text = element_text(size=18))+ theme(legend.position="none")+theme(axis.title = element_text(size=15))
  print(p_r2)
```

### Compare volcano plots

```{r, fig.height=10}
## CD4T 
## Create 3 volcano plots, mark the true positive findings

cd4t_tb_iv <- tables[[3]]
cd4t_tb_tf <- tables_tf_new[[3]]
cd4t_tb_scgen <- tables_scgen[[3]]

## in vitro

keyvals <- ifelse(abs(cd4t_tb_iv$logFC) > 0.3, "red", "grey")
names(keyvals)[keyvals=="red"] <- "DE"
names(keyvals)[keyvals=="grey"] <- "Not DE"

vp_iv <- EnhancedVolcano(cd4t_tb_iv,
                         x="logFC",
                         y="adj.P.Val",
                         lab=rownames(cd4t_tb_iv),
                         pCutoff=1e-10,
                         FCcutoff = 0.3,
                         colCustom = keyvals,
                         colAlpha = 1,
                         legendPosition = "top",
                         pointSize = c(ifelse(abs(cd4t_tb_iv$logFC) > 0.3,4,2)),
                         drawConnectors = TRUE,
                         widthConnectors = 0.5,
                         title = "In Vitro DEG",
                         subtitle = "",
                         xlim = c(-1,2.2))
vp_iv

########
tp_tf <- intersect(DEG_genes_obs[[3]],DEG_genes_tf[[3]])
keyvals <- ifelse(abs(cd4t_tb_tf$logFC) <= 0.3, "grey", 
                  ifelse(cd4t_tb_tf$Row.names %in% tp_tf,"red","blue"))
names(keyvals)[keyvals=="blue"] <- "FP"
names(keyvals)[keyvals=="grey"] <- "Not DE"
names(keyvals)[keyvals=="red"] <- "TP"

vp_tf <- EnhancedVolcano(cd4t_tb_tf,
                         x="logFC",
                         y="pval",
                         lab=cd4t_tb_tf$Row.names,
                         selectLab = tp_tf,
                         pCutoff=1e-10,
                         FCcutoff = 0.3,
                         colCustom = keyvals,
                         colAlpha = 1,
                         legendPosition = "top",
                         pointSize = c(ifelse(cd4t_tb_tf$Row.names %in% tp_tf, 4,2)),
                         drawConnectors = TRUE,
                         widthConnectors = 0.5,
                         title = "Two-factor DEG",
                         subtitle = "",
                         max.overlaps = 50,
                         xlim = c(-1,2.5)
                         )
vp_tf
#########
tp_scgen <- intersect(DEG_genes_obs[[3]],DEG_genes_scgen[[3]])
keyvals <- ifelse(abs(cd4t_tb_scgen$logFC) <= 0.3, "grey", 
                  ifelse(rownames(cd4t_tb_scgen) %in% tp_scgen,"red","blue"))
names(keyvals)[keyvals=="blue"] <- "FP"
names(keyvals)[keyvals=="grey"] <- "Not DE"
names(keyvals)[keyvals=="red"] <- "TP"

vp_scgen <- EnhancedVolcano(cd4t_tb_scgen,
                         x="logFC",
                         y="adj.P.Val",
                         lab=rownames(cd4t_tb_scgen),
                         selectLab = tp_scgen,
                         pCutoff=1e-10,
                         FCcutoff = 0.3,
                         colCustom = keyvals,
                         colAlpha = 1,
                         legendPosition = "top",
                         pointSize = c(ifelse(rownames(cd4t_tb_scgen) %in% tp_scgen, 4,2)),
                         drawConnectors = TRUE,
                         widthConnectors = 0.5,
                         title = "scGen DEG",
                         subtitle = "",
                         max.overlaps = 50,
                         xlim = c(-1,2.2)
                         )
vp_scgen

library(gridExtra)
library(grid)
library(cowplot)
pdf("test.pdf",height = 8, width = 25)
plot_grid(vp_iv,vp_tf,vp_scgen, ncol = 3)
dev.off()

vp <- plot_grid(vp_iv,vp_tf,vp_scgen, ncol = 3)


```

### Compare scatter plot for confusion matrix

```{r}
## cd4t
lfc_dt_cd4t <- data.frame(rbind(dt_scgen_list[[3]],dt_tf_list[[3]]))
m <- c(rep("scGen",nrow(dt_scgen_list[[3]])),rep("Two-factor",nrow(dt_tf_list[[3]])))
lfc_dt_cd4t <- data.frame(lfc_dt_cd4t,m)

p_cfm <- ggplot(lfc_dt_cd4t, aes(x=prediction, y=observation, color=status)) + 
  geom_point(shape=1,alpha=1)+
  geom_hline(yintercept=0.3, linetype="dashed", color = "black")+
  geom_hline(yintercept=-0.3, linetype="dashed", color = "black")+
  geom_vline(xintercept=0.3, linetype="dashed", color = "black")+
  geom_vline(xintercept=-0.3, linetype="dashed", color = "black")+
  xlab("Predicted LogFC") + ylab("In vitro LogFC")+ 
  theme(strip.text = element_text(size=18))+facet_wrap(~m, nrow=1)+ theme(legend.position="none")+theme(axis.title = element_text(size=15))
  print(p_cfm)
```

### PR-curve

```{r}
  true <- rep(0,length(genes))
  true[which(genes %in% DEG_genes_obs[[3]])] <- 1
  dt <- data.frame(as.factor(true),score_scgen[[3]])
  names(dt) <- c("true","score")
  dt2 <- data.frame(as.factor(true),score_tf[[3]])
  names(dt2) <- c("true","score")
  dtf <- rbind(dt,dt2)
  method <- c(rep("scgen",nrow(dt)),rep("two-factor",nrow(dt2)))
  dtf <- data.frame(dtf,method)
  p_pr <- dtf %>%
         group_by(method) %>%
         pr_curve(true, score, event_level = "second") %>%
         ggplot(aes(x = recall, y = precision, color=method)) +
         geom_vline(xintercept = length(tp_genes_scgen[[3]])/length(DEG_genes_obs[[3]]),color="red",linetype="dashed")+
         geom_vline(xintercept = length(tp_genes_tf[[3]])/length(DEG_genes_obs[[3]]),color="light blue",linetype="dashed")+
         geom_path() +
         coord_equal() +
         theme_bw()+theme(axis.title = element_text(size=15))+theme(legend.key.size = unit(1.5,"cm"))
         print(p_pr)
```

```{r,fig.height=24}
## arrange all results for CD4T
library(cowplot)

row1 <- plot_grid(vp_iv,vp_tf,vp_scgen,align = "h",nrow=1)
row2 <- plot_grid(p_r2,p_cfm,p_pr,align="h",axis = "t",nrow=1,labels = c("B","C","D"),label_size = 36)
p <- plot_grid(row1,row2,nrow=2, align="hv",labels = c("A",""),label_size = 36)
plot_grid

pdf("CD4T.pdf",height=15,width = 30)
plot_grid(row1,row2,nrow=2, align="hv",labels = c("A",""),label_size = 36)
dev.off()

```

## Get plots for CD14

### Compare R2

```{r}
  status <- rep("non DE", length(genes))
  status[which(genes %in% DEG_genes_obs[[6]])] <- "DE"
  observation <- kang_sti_m[[6]]
  prediction <- tf_pred[[6]]
  dt_r2_tf <- data.frame(genes,observation,prediction,status)
  names(dt_r2_tf) <- c("genes", "observation", "prediction", "status")
  
  observation <- kang_sti_m[[6]]
  prediction <- scgen_pred_m[[6]]
  dt_r2_scgen <- data.frame(genes,observation,prediction,status)
  names(dt_r2_scgen) <- c("genes", "observation", "prediction", "status")
  
  dt_r2 <- data.frame(rbind(dt_r2_scgen,dt_r2_tf))
  method <- c(rep("scgen",nrow(dt_r2_scgen)),rep("two-factor",nrow(dt_r2_tf)))
  dt_r2 <- data.frame(dt_r2,method)
  
  
  labs <- c(paste0("scgen, R2=",R2_scgen[6]),paste0("two-factor, R2=",R2_tf[6]))
  names(labs) <- c("scgen","two-factor")
  p_r2 <- ggplot(dt_r2, aes(x=prediction, y=observation, color=status)) + 
  geom_point()+
  geom_smooth(method=lm, na.rm = TRUE,colour="black")+
  scale_colour_manual(name="status", values=c("red","blue"))+
  xlab("predicted stimulated expressions") + ylab("In vitro stimulated expressions")+facet_wrap(~method,nrow = 1,labeller = labeller(method=labs))+theme(strip.text = element_text(size=18))+ theme(legend.position="none")+theme(axis.title = element_text(size=15))
  print(p_r2)
```

### Compare volcano plots

```{r, fig.height=10}
## CD4T 
## Create 3 volcano plots, mark the true positive findings

cd14_tb_iv <- tables[[6]]
cd14_tb_tf <- tables_tf_new[[6]]
cd14_tb_scgen <- tables_scgen[[6]]

## in vitro

keyvals <- ifelse(abs(cd14_tb_iv$logFC) > 0.3, "red", "grey")
names(keyvals)[keyvals=="red"] <- "DE"
names(keyvals)[keyvals=="grey"] <- "Not DE"

vp_iv <- EnhancedVolcano(cd14_tb_iv,
                         x="logFC",
                         y="adj.P.Val",
                         lab=rownames(cd14_tb_iv),
                         pCutoff=1e-10,
                         FCcutoff = 0.3,
                         colCustom = keyvals,
                         colAlpha = 1,
                         legendPosition = "top",
                         pointSize = c(ifelse(abs(cd14_tb_iv$logFC) > 0.3,4,2)),
                         drawConnectors = TRUE,
                         widthConnectors = 0.5,
                         title = "In Vitro DEG",
                         subtitle = "",
                         xlim = c(-1,2.2))
vp_iv

########
tp_tf <- intersect(DEG_genes_obs[[6]],DEG_genes_tf[[6]])
keyvals <- ifelse(abs(cd14_tb_tf$logFC) <= 0.3, "grey", 
                  ifelse(cd14_tb_tf$Row.names %in% tp_tf,"red","blue"))
names(keyvals)[keyvals=="blue"] <- "FP"
names(keyvals)[keyvals=="grey"] <- "Not DE"
names(keyvals)[keyvals=="red"] <- "TP"

vp_tf <- EnhancedVolcano(cd14_tb_tf,
                         x="logFC",
                         y="pval",
                         lab=cd14_tb_tf$Row.names,
                         selectLab = tp_tf,
                         pCutoff=1e-10,
                         FCcutoff = 0.3,
                         colCustom = keyvals,
                         colAlpha = 1,
                         legendPosition = "top",
                         pointSize = c(ifelse(cd14_tb_tf$Row.names %in% tp_tf, 4,2)),
                         drawConnectors = TRUE,
                         widthConnectors = 0.5,
                         title = "Two-factor DEG",
                         subtitle = "",
                         max.overlaps = 50,
                         xlim = c(-1,2.5)
                         )
vp_tf
#########
tp_scgen <- intersect(DEG_genes_obs[[6]],DEG_genes_scgen[[6]])
keyvals <- ifelse(abs(cd14_tb_scgen$logFC) <= 0.3, "grey", 
                  ifelse(rownames(cd14_tb_scgen) %in% tp_scgen,"red","blue"))
names(keyvals)[keyvals=="blue"] <- "FP"
names(keyvals)[keyvals=="grey"] <- "Not DE"
names(keyvals)[keyvals=="red"] <- "TP"

vp_scgen <- EnhancedVolcano(cd14_tb_scgen,
                         x="logFC",
                         y="adj.P.Val",
                         lab=rownames(cd14_tb_scgen),
                         selectLab = tp_scgen,
                         pCutoff=1e-10,
                         FCcutoff = 0.3,
                         colCustom = keyvals,
                         colAlpha = 1,
                         legendPosition = "top",
                         pointSize = c(ifelse(rownames(cd14_tb_scgen) %in% tp_scgen, 4,2)),
                         drawConnectors = TRUE,
                         widthConnectors = 0.5,
                         title = "scGen DEG",
                         subtitle = "",
                         max.overlaps = 50,
                         xlim = c(-1,2.2)
                         )
vp_scgen

library(gridExtra)
library(grid)
library(cowplot)
pdf("test.pdf",height = 8, width = 25)
plot_grid(vp_iv,vp_tf,vp_scgen, ncol = 3)
dev.off()

vp <- plot_grid(vp_iv,vp_tf,vp_scgen, ncol = 3)


```

### Compare scatter plot for confusion matrix

```{r}
## cd14
lfc_dt_cd14 <- data.frame(rbind(dt_scgen_list[[6]],dt_tf_list[[6]]))
m <- c(rep("scGen",nrow(dt_scgen_list[[6]])),rep("Two-factor",nrow(dt_tf_list[[6]])))
lfc_dt_cd14 <- data.frame(lfc_dt_cd14,m)

p_cfm <- ggplot(lfc_dt_cd14, aes(x=prediction, y=observation, color=status)) + 
  geom_point(shape=1,alpha=1)+
  geom_hline(yintercept=0.3, linetype="dashed", color = "black")+
  geom_hline(yintercept=-0.3, linetype="dashed", color = "black")+
  geom_vline(xintercept=0.3, linetype="dashed", color = "black")+
  geom_vline(xintercept=-0.3, linetype="dashed", color = "black")+
  xlab("Predicted LogFC") + ylab("In vitro LogFC")+ 
  theme(strip.text = element_text(size=18))+facet_wrap(~m, nrow=1)+ theme(legend.position="none")+theme(axis.title = element_text(size=15))
  print(p_cfm)
```

### PR-curve

```{r}
  true <- rep(0,length(genes))
  true[which(genes %in% DEG_genes_obs[[6]])] <- 1
  dt <- data.frame(as.factor(true),score_scgen[[6]])
  names(dt) <- c("true","score")
  dt2 <- data.frame(as.factor(true),score_tf[[6]])
  names(dt2) <- c("true","score")
  dtf <- rbind(dt,dt2)
  method <- c(rep("scgen",nrow(dt)),rep("two-factor",nrow(dt2)))
  dtf <- data.frame(dtf,method)
  p_pr <- dtf %>%
         group_by(method) %>%
         pr_curve(true, score, event_level = "second") %>%
         ggplot(aes(x = recall, y = precision, color=method)) +
         geom_vline(xintercept = length(tp_genes_scgen[[6]])/length(DEG_genes_obs[[6]]),color="red",linetype="dashed")+
         geom_vline(xintercept = length(tp_genes_tf[[6]])/length(DEG_genes_obs[[6]]),color="light blue",linetype="dashed")+
         geom_path() +
         coord_equal() +
         theme_bw()+theme(axis.title = element_text(size=15))+theme(legend.key.size = unit(1.5,"cm"))
         print(p_pr)
```

```{r,fig.height=24}
## arrange all results for CD4T
library(cowplot)

row1 <- plot_grid(vp_iv,vp_tf,vp_scgen,align = "h",nrow=1)
row2 <- plot_grid(p_r2,p_cfm,p_pr,align="h",axis = "t",nrow=1,labels = c("B","C","D"),label_size = 36)
p <- plot_grid(row1,row2,nrow=2, align="hv",labels = c("A",""),label_size = 36)
plot_grid

pdf("CD14.pdf",height=15,width = 30)
plot_grid(row1,row2,nrow=2, align="hv",labels = c("A",""),label_size = 36)
dev.off()

```

## Compare results across all cell types

```{r}
library(latex2exp)
## R2 barplot
cell_type <- c(ctype,ctype)
R2 <- c(R2_scgen,R2_tf)
model <- c(rep("scgen",length(ctype)),rep("two-factor",length(ctype)))
dtf1 <- data.frame(cell_type,R2,model)

p1 <- ggplot(dtf1, aes(fill=model, y=R2, x=cell_type)) + geom_bar(position = "dodge", stat="identity")+geom_text(aes(label = R2),position = position_dodge(width = 0.9), vjust=-0.3)+xlab("Cell type")+
  ylab(TeX(r'($R^2$)'))+ theme(legend.position="none")
p1
```

```{r}
### auc pr barplot
scgen_pr_auc <- c()
for (i in 1:length(pr_auc_scgen)){
  scgen_pr_auc[i] <- round(as.numeric(pr_auc_scgen[[i]][1,3]),2)
}

tf_pr_auc <- c()
for (i in 1:length(pr_auc_tf)){
  tf_pr_auc[i] <- round(as.numeric(pr_auc_tf[[i]][1,3]),2)
}

pr_auc <- c(scgen_pr_auc,tf_pr_auc)
dtf2 <- data.frame(cell_type,pr_auc,model)

p2 <- ggplot(dtf2, aes(fill=model, y=pr_auc, x=cell_type)) + geom_bar(position = "dodge", stat="identity")+geom_text(aes(label = pr_auc),position = position_dodge(width = 0.9), vjust=-0.3)+xlab("Cell type")+ylab("AUC-PR")
p2


```

```{r,fig.width=20}
pdf("r2_auc.pdf",height = 8, width = 20)
plot_grid(p1,p2,nrow=1,rel_widths = c(1,1.2),labels = c("A","B"))
dev.off()
```