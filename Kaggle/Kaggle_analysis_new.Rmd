---
title: "Kaggle_bulked_eda"
author: "Hongxu Zhu"
always_allow_html: yes
date: "`r Sys.Date()`"
output:
  html_document:
    theme: united
    toc: yes
    toc_collapsed: yes
    toc_float: yes
---

```{r alternative-preambles,echo=FALSE,include=FALSE,eval=FALSE}
## if using word replace output with
output:
  word_document:
    toc: yes

## if using pdf replace output with
output:
  pdf_document:
    toc: yes
header-includes:
  - \usepackage{xcolor}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

## colorizes text when using html or pdf output
## just spits out text x for word
colorize <- function(x, color) {
  if(color=="todo"){
    color <- "red"
    x <- paste0("TODO: ",x)
  }
  if (knitr::is_latex_output()) {
    sprintf("\\textcolor{%s}{%s}", color, x)
  } else if (knitr::is_html_output()) {
    sprintf("<span style='color: %s;'>%s</span>", color, 
      x)
  } else x
}

todo <- function(x){
  paste0("**",colorize(x,"todo"),"**")
}

library(kableExtra)
library(cmapR)
library(edgeR)
library(arrow)
library(latex2exp)
```

## Input bulked data

```{r}
bulk_adata_obs <- read.csv("datasets/bulk_adata_obs.csv")
bulk_adata_var <- read.csv("datasets/bulk_adata_var.csv")
bulk_adata_X <- read.csv("datasets/bulk_adata_X.csv", header = TRUE)
bulk_adata_X <- bulk_adata_X[,-1]
gene_name <- rownames(bulk_adata_var)
```


## Input reference file

```{r}
de_train <- read_parquet("datasets/de_train.parquet")
```

## Input Computed DEG results, Compute score and compare to reference file

```{r}
library(gtools)
library(ggplot2)
c_type <- c("B cells", "Myeloid cells","NK cells","T cells CD4_","T cells CD8+","T regulatory cells")
paths <- c("pseudo-bulking/pseudo-bulking/cell_type_B","pseudo-bulking/pseudo-bulking/cell_type_Myeloid", "pseudo-bulking/pseudo-bulking/cell_type_NK","pseudo-bulking/pseudo-bulking/cell_type_T4","pseudo-bulking/pseudo-bulking/cell_type_T8","pseudo-bulking/pseudo-bulking/cell_type_Treg")
pattern <- "*.csv"

## Create data frame with p-value

DE_p_value_list <- list()
for (i in 1: length(paths)){
  path <- paths[i]
  file_list <- mixedsort(list.files(path, pattern, full.names = TRUE))
  temp <- lapply(file_list, read.csv)
  DE_p_value <- data.frame()
  for (j in 1: length(temp)){
    DE_p_value <- rbind(DE_p_value,t(temp[[j]]$P.Value))
  }
  DE_p_value_list[[i]] <- DE_p_value
}

DE_p_value_df <- data.frame()
for (i in 1: length(DE_p_value_list)){
  DE_p_value_df <- rbind(DE_p_value_df,DE_p_value_list[[i]])
}

names(DE_p_value_df) <- gene_name

## Create data frame with log fold change

DE_lfc_list <- list()
for (i in 1: length(paths)){
  path <- paths[i]
  file_list <- mixedsort(list.files(path, pattern, full.names = TRUE))
  temp <- lapply(file_list, read.csv)
  DE_lfc <- data.frame()
  for (j in 1: length(temp)){
    DE_lfc <- rbind(DE_lfc,t(temp[[j]]$logFC))
  }
  DE_lfc_list[[i]] <- DE_lfc
}

DE_lfc_df <- data.frame()
for (i in 1: length(DE_lfc_list)){
  DE_lfc_df <- rbind(DE_lfc_df,DE_lfc_list[[i]])
}

names(DE_lfc_df) <- gene_name

## meta data for the created data frames

meta_path <- "pseudo-bulking/pseudo-bulking/input_obs"
meta_file_list <- list.files(meta_path,pattern,full.names = TRUE)
input_obs <- lapply(meta_file_list, read.csv)


# Note that, for DE result files, pert are labeled as "Rpert[number]" which could be found in the input_obs

Rpert_B <- c(0:4,6:17)
Rpert_Myeloid <- c(0:4,6:17)
Rpert_NK <- c(0:26,28:146)
Rpert_T4 <- c(0:24,26:146)
Rpert_T8 <- c(0:21,23:142)
Rpert_Treg <- c(0:26,28:146)

sm_name_B <- c()
for (i in 1:length(Rpert_B)){
  sm_name_B[i] <- unique(input_obs[[1]]$sm_name[input_obs[[1]]$Rpert==Rpert_B[i]])
}

sm_name_Myeloid <- c()
for (i in 1:length(Rpert_Myeloid)){
  sm_name_Myeloid[i] <- unique(input_obs[[2]]$sm_name[input_obs[[2]]$Rpert==Rpert_Myeloid[i]])
}

sm_name_NK <- c()
for (i in 1:length(Rpert_NK)){
  sm_name_NK[i] <- unique(input_obs[[3]]$sm_name[input_obs[[3]]$Rpert==Rpert_NK[i]])
}

sm_name_T4 <- c()
for (i in 1:length(Rpert_T4)){
  sm_name_T4[i] <- unique(input_obs[[4]]$sm_name[input_obs[[4]]$Rpert==Rpert_T4[i]])
}

sm_name_T8 <- c()
for (i in 1:length(Rpert_T8)){
  sm_name_T8[i] <- unique(input_obs[[5]]$sm_name[input_obs[[5]]$Rpert==Rpert_T8[i]])
}

sm_name_Treg <- c()
for (i in 1:length(Rpert_Treg)){
  sm_name_Treg[i] <- unique(input_obs[[6]]$sm_name[input_obs[[6]]$Rpert==Rpert_Treg[i]])
}

### Now we can create pert name for our p-value, logfc data frames

sm_name <- c(sm_name_B,sm_name_Myeloid,sm_name_NK,sm_name_T4,sm_name_T8,sm_name_Treg)

cell_type_name <- unique(de_train$cell_type)

cell_type <- c(rep("B cells",length(sm_name_B)),rep("Myeloid cells",length(sm_name_Myeloid)),rep("NK cells",length(sm_name_NK)),rep("T cells CD4+",length(sm_name_T4)),rep("T cells CD8+",length(sm_name_T8)),rep("T regulatory cells",length(sm_name_Treg)))

## Now add cell type and sm name to DE data frames

DE_p_value_df <- data.frame(cell_type,sm_name,DE_p_value_df)
DE_lfc_df <- data.frame(cell_type,sm_name,DE_lfc_df)

## compute score

score_df <- -log10(DE_p_value_df[,-(1:2)])*sign(DE_lfc_df[,-(1:2)])
score_df <- data.frame(cell_type,sm_name,score_df)

## Compare computed score with de_train(ground truth)

## Check all scatter plots
ct <- "T cells CD4+"
sn <- sm_name_T4[56:77]

for (i in 1: length(sn)){
  c1 <- score_df[score_df$cell_type==ct & score_df$sm_name==sn[i],-c(1,2)]
  c2 <- de_train[de_train$cell_type==ct & de_train$sm_name==sn[i],-(1:5)]
  computed <- t(data.frame(c1))
  truth <- t(data.frame(c2))
  df <- data.frame(computed,truth)
  names(df) <- c("computed","truth")
  p <- ggplot(df,aes(x=truth,y=computed))+geom_point(color="blue")
  print(p)
}

## We get the same results as the reference file
```
```{r, fig.height=10}
## Show some volcano plots
## B cells

B_pval <- DE_p_value[DE_p_value_df$cell_type=="B cells",]
names(B_pval) <- gene_name
B_lfc <- DE_lfc[DE_lfc_df$cell_type=="B cells",]
names(B_lfc) <- gene_name

library(EnhancedVolcano)

for (i in 1: nrow(B_pval)){
  df_temp <- data.frame(gene_name,t(B_pval[i,]),t(B_lfc[i,]))
  names(df_temp) <- c("gene_name","P.Val","logFC")
  v <- EnhancedVolcano(df_temp,
       lab = gene_name,
       title = paste0("B cells","__",sm_name_B[i]),
       x = 'logFC',
       y = 'P.Val',
       pCutoff=0.05,
       FCcutoff = 1,
       ylim = c(0,max(-log10(df_temp$P.Val))+0.5))
  print(v)
}
```

```{r,fig.height=10}
## NK cells
NK_pval <- DE_p_value[DE_p_value_df$cell_type=="NK cells",]
names(NK_pval) <- gene_name
NK_lfc <- DE_lfc[DE_lfc_df$cell_type=="NK cells",]
names(NK_lfc) <- gene_name

library(EnhancedVolcano)

for (i in 15: 36){
  df_temp <- data.frame(gene_name,t(NK_pval[i,]),t(NK_lfc[i,]))
  names(df_temp) <- c("gene_name","P.Val","logFC")
  v <- EnhancedVolcano(df_temp,
       lab = gene_name,
       title = paste0("NK cells","__",sm_name_NK[i]),
       x = 'logFC',
       y = 'P.Val',
       pCutoff=0.05,
       FCcutoff = 1,
       ylim = c(0,max(-log10(df_temp$P.Val))+0.5))
  print(v)
}
```

## Work with pseudo-bulked data

```{r}
## take necessary variables in meta data
bulk_meta <- data.frame(bulk_adata_obs$cell_type,bulk_adata_obs$plate_name,bulk_adata_obs$row,bulk_adata_obs$donor_id,bulk_adata_obs$sm_lincs_id, bulk_adata_obs$sm_name)

names(bulk_meta) <- c("cell_type","plate_name","row","donor_id","sm_lincs_id","sm_name")
bulk_meta$sm_name[bulk_meta$sm_name=="Dimethyl Sulfoxide"] <- "DMSO"

## merge meta data and expression data
names(bulk_adata_X) <- gene_name
bulk_full <- data.frame(bulk_meta,bulk_adata_X)

```

### Overview of full data

```{r}
library(ComplexHeatmap)
tab <- table(bulk_meta$cell_type,bulk_meta$sm_lincs_id)
tab <- 1*(tab>0)
tab <- tab[,order(colSums(tab),decreasing=TRUE)]
tab <- tab[order(rowSums(tab),decreasing=FALSE),]
temp <- matrix(tab,nrow=nrow(tab))
dimnames(temp) <- dimnames(tab)
fsize <- 10

pdf("heatmap.pdf",width=20,height=10)
Heatmap(temp,col=c("white","blue"),cluster_rows=FALSE,cluster_columns=FALSE,row_title="Cell   type",column_title="Perturbation",show_row_names=TRUE,row_names_gp = gpar(fontsize=10),column_names_gp = gpar(fontsize=8), show_heatmap_legend=FALSE, rect_gp = gpar(col="grey"))
dev.off()
```

```{r}
## Create all possible combinations in the dataset
cmb <- data.frame(bulk_meta$cell_type,bulk_meta$sm_name)
cmb_vec <- paste0(bulk_meta$cell_type,"#",bulk_meta$sm_name)
cmb_uni <- unique(cmb_vec)
cmb_list <- strsplit(cmb_uni, split = "#")

cmb_cell <- c()
cmb_pert <- c()
for (i in 1:length(cmb_list)){
  cmb_cell[i] <- cmb_list[[i]][1]
  cmb_pert[i] <- cmb_list[[i]][2]
}

cmb_df <- data.frame(cmb_cell,cmb_pert)
names(cmb_df) <- c("cell_type", "sm_name")

## Don't use DMSO as testing set

cmb_df <- cmb_df[-which(cmb_df$sm_name=="DMSO"),]
```

## Data cleaning

### pre-porcess

For this pseudo-bulked data set, our plan is to fit in silico models on each cluster. We then use the prediction from in silico models on each cluster to perform the in silico DEG following the same in vitro DEG pipeline.

```{r}
## check number of samples for each combination
check <- c()
for (ii in 1: nrow(cmb_df)){
  a <- bulk_meta$cell_type==cmb_df$cell_type[ii] & bulk_meta$sm_name==cmb_df$sm_name[ii]
  check[ii] <- nrow(bulk_meta[a,])
}

check

## We may remove combinations that less than 3 samples

```

```{r}
## get filtered dataset

rm_index_list <- list()
c <- 0
for (ii in 1: nrow(cmb_df)){
  a <- bulk_meta$cell_type==cmb_df$cell_type[ii] & bulk_meta$sm_name==cmb_df$sm_name[ii]
  if (nrow(bulk_meta[a,])<3){
    c <- c+1
    rm_index_list[[c]] <- as.numeric(rownames(bulk_meta[a,]))
  }
}

rm_index <- c()
for (ii in 1:length(rm_index_list)){
  rm_index <- c(rm_index,rm_index_list[[ii]])
}

bulk_meta_rm <- bulk_meta[-rm_index,]
bulk_adata_X_rm <- bulk_adata_X[-rm_index,]

bulk_meta_d0 <- bulk_meta_rm[bulk_meta_rm$donor_id=="donor_0",]
bulk_meta_d1 <- bulk_meta_rm[bulk_meta_rm$donor_id=="donor_1",]
bulk_meta_d2 <- bulk_meta_rm[bulk_meta_rm$donor_id=="donor_2",]

bulk_X_d0 <- bulk_adata_X_rm[bulk_meta_rm$donor_id=="donor_0",]
bulk_X_d1 <- bulk_adata_X_rm[bulk_meta_rm$donor_id=="donor_1",]
bulk_X_d2 <- bulk_adata_X_rm[bulk_meta_rm$donor_id=="donor_2",]
```

```{r}
## check combinations in each donor
## Exclude all controls: "DMSO", "Dabrafenib" and "Belinostat" in test set.

### d0
cmb_d0 <- data.frame(bulk_meta_d0$cell_type,bulk_meta_d0$sm_name)
cmb_d0_vec <- paste0(bulk_meta_d0$cell_type,"#",bulk_meta_d0$sm_name)
cmb_d0_uni <- unique(cmb_d0_vec)
cmb_d0_list <- strsplit(cmb_d0_uni, split = "#")

cmb_d0_cell <- c()
cmb_d0_pert <- c()
for (i in 1:length(cmb_d0_list)){
  cmb_d0_cell[i] <- cmb_d0_list[[i]][1]
  cmb_d0_pert[i] <- cmb_d0_list[[i]][2]
}

cmb_d0_df <- data.frame(cmb_d0_cell,cmb_d0_pert)
names(cmb_d0_df) <- c("cell_type", "sm_name")
cmb_d0_df <- cmb_d0_df[-which(cmb_d0_df$sm_name=="DMSO" | cmb_d0_df$sm_name=="Dabrafenib" | cmb_d0_df$sm_name=="Belinostat"),]

### d1
cmb_d1 <- data.frame(bulk_meta_d1$cell_type,bulk_meta_d1$sm_name)
cmb_d1_vec <- paste0(bulk_meta_d1$cell_type,"#",bulk_meta_d1$sm_name)
cmb_d1_uni <- unique(cmb_d1_vec)
cmb_d1_list <- strsplit(cmb_d1_uni, split = "#")

cmb_d1_cell <- c()
cmb_d1_pert <- c()
for (i in 1:length(cmb_d1_list)){
  cmb_d1_cell[i] <- cmb_d1_list[[i]][1]
  cmb_d1_pert[i] <- cmb_d1_list[[i]][2]
}

cmb_d1_df <- data.frame(cmb_d1_cell,cmb_d1_pert)
names(cmb_d1_df) <- c("cell_type", "sm_name")
cmb_d1_df <- cmb_d0_df[-which(cmb_d1_df$sm_name=="DMSO" | cmb_d1_df$sm_name=="Dabrafenib" | cmb_d1_df$sm_name=="Belinostat"),]


### d2
cmb_d2 <- data.frame(bulk_meta_d2$cell_type,bulk_meta_d2$sm_name)
cmb_d2_vec <- paste0(bulk_meta_d2$cell_type,"#",bulk_meta_d2$sm_name)
cmb_d2_uni <- unique(cmb_d2_vec)
cmb_d2_list <- strsplit(cmb_d2_uni, split = "#")

cmb_d2_cell <- c()
cmb_d2_pert <- c()
for (i in 1:length(cmb_d2_list)){
  cmb_d2_cell[i] <- cmb_d2_list[[i]][1]
  cmb_d2_pert[i] <- cmb_d2_list[[i]][2]
}

cmb_d2_df <- data.frame(cmb_d2_cell,cmb_d2_pert)
names(cmb_d2_df) <- c("cell_type", "sm_name")
cmb_d2_df <- cmb_d2_df[-which(cmb_d2_df$sm_name=="DMSO" | cmb_d2_df$sm_name=="Dabrafenib" | cmb_d2_df$sm_name=="Belinostat"),]

```

### split training and testing

```{r}
## first, get intersection of combination set of d0, d1, d2
d0_pairs <- unique(paste0(cmb_d0_df$cell_type,"#",cmb_d0_df$sm_name))
d1_pairs <- unique(paste0(cmb_d1_df$cell_type,"#",cmb_d1_df$sm_name))
d2_pairs <- unique(paste0(cmb_d2_df$cell_type,"#",cmb_d2_df$sm_name))

int1 <- intersect(d0_pairs,d1_pairs)
int_012 <- intersect(int1,d2_pairs)

pairs_list <- strsplit(int_012, split = "#")

pairs_cell <- c()
pairs_pert <- c()
for (i in 1:length(pairs_list)){
  pairs_cell[i] <- pairs_list[[i]][1]
  pairs_pert[i] <- pairs_list[[i]][2]
}

pairs_df <- data.frame(pairs_cell,pairs_pert)
names(pairs_df) <- c("cell_type","sm_name")

### get training and testing pairs

test_index <- sample(1:nrow(pairs_df), 100, replace = FALSE)

pairs_test <- pairs_df[sort(test_index),]
pairs_train <- pairs_df[-sort(test_index),]

### get training set for each group

d0_train_meta <- data.frame()
for (i in 1:nrow(pairs_train)){
  ix <- bulk_meta_d0$cell_type==pairs_train$cell_type[i] & bulk_meta_d0$sm_name==pairs_train$sm_name[i]
  d0_train_meta <- data.frame(rbind(d0_train_meta,bulk_meta_d0[ix,]))
}

d1_train_meta <- data.frame()
for (i in 1:nrow(pairs_train)){
  ix <- bulk_meta_d1$cell_type==pairs_train$cell_type[i] & bulk_meta_d1$sm_name==pairs_train$sm_name[i]
  d1_train_meta <- data.frame(rbind(d1_train_meta,bulk_meta_d1[ix,]))
}

d2_train_meta <- data.frame()
for (i in 1:nrow(pairs_train)){
  ix <- bulk_meta_d2$cell_type==pairs_train$cell_type[i] & bulk_meta_d2$sm_name==pairs_train$sm_name[i]
  d2_train_meta <- data.frame(rbind(d2_train_meta,bulk_meta_d2[ix,]))
}

index <- c()
for (i in 1: nrow(pairs_train)){
  ix <- bulk_meta_d0$cell_type==pairs_train$cell_type[i] & bulk_meta_d0$sm_name==pairs_train$sm_name[i]
  index[i] <- row.names(bulk_meta_d0[ix,])
}

d0_train_X <- bulk_X_d0[row.names(bulk_X_d0) %in% index,]

index <- c()
for (i in 1: nrow(pairs_train)){
  ix <- bulk_meta_d1$cell_type==pairs_train$cell_type[i] & bulk_meta_d1$sm_name==pairs_train$sm_name[i]
  index[i] <- row.names(bulk_meta_d1[ix,])
}

d1_train_X <- bulk_X_d1[row.names(bulk_X_d1) %in% index,]

index <- c()
for (i in 1: nrow(pairs_train)){
  ix <- bulk_meta_d2$cell_type==pairs_train$cell_type[i] & bulk_meta_d2$sm_name==pairs_train$sm_name[i]
  index[i] <- row.names(bulk_meta_d2[ix,])
}

d2_train_X <- bulk_X_d2[row.names(bulk_X_d2) %in% index,]

### get testing set for each group

d0_test_meta <- data.frame()
for (i in 1:nrow(pairs_test)){
  ix <- bulk_meta_d0$cell_type==pairs_test$cell_type[i] & bulk_meta_d0$sm_name==pairs_test$sm_name[i]
  d0_test_meta <- data.frame(rbind(d0_test_meta,bulk_meta_d0[ix,]))
}

d1_test_meta <- data.frame()
for (i in 1:nrow(pairs_test)){
  ix <- bulk_meta_d1$cell_type==pairs_test$cell_type[i] & bulk_meta_d1$sm_name==pairs_test$sm_name[i]
  d1_test_meta <- data.frame(rbind(d1_test_meta,bulk_meta_d1[ix,]))
}

d2_test_meta <- data.frame()
for (i in 1:nrow(pairs_test)){
  ix <- bulk_meta_d2$cell_type==pairs_test$cell_type[i] & bulk_meta_d2$sm_name==pairs_test$sm_name[i]
  d2_test_meta <- data.frame(rbind(d2_test_meta,bulk_meta_d2[ix,]))
}

index <- c()
for (i in 1: nrow(pairs_test)){
  ix <- bulk_meta_d0$cell_type==pairs_test$cell_type[i] & bulk_meta_d0$sm_name==pairs_test$sm_name[i]
  index[i] <- row.names(bulk_meta_d0[ix,])
}

d0_test_X <- bulk_X_d0[row.names(bulk_X_d0) %in% index,]

index <- c()
for (i in 1: nrow(pairs_test)){
  ix <- bulk_meta_d1$cell_type==pairs_test$cell_type[i] & bulk_meta_d1$sm_name==pairs_test$sm_name[i]
  index[i] <- row.names(bulk_meta_d1[ix,])
}

d1_test_X <- bulk_X_d1[row.names(bulk_X_d1) %in% index,]

index <- c()
for (i in 1: nrow(pairs_test)){
  ix <- bulk_meta_d2$cell_type==pairs_test$cell_type[i] & bulk_meta_d2$sm_name==pairs_test$sm_name[i]
  index[i] <- row.names(bulk_meta_d2[ix,])
}

d2_test_X <- bulk_X_d2[row.names(bulk_X_d2) %in% index,]

```

## Fit in silico models on pseudo-bulked level

### Cell type model

```{r}
## for d0

fit <- lm(as.matrix(bulk_X_d0) ~ bulk_meta_d0$cell_type + bulk_meta_d0$plate_name + bulk_meta_d0$row, x=TRUE)

index_test <- c()
for (i in 1: nrow(pairs_test)){
  ix <- bulk_meta_d0$cell_type==pairs_test$cell_type[i] & bulk_meta_d0$sm_name==pairs_test$sm_name[i]
  index_test[i] <- row.names(bulk_meta_d0[ix,])
}

obs_test <- fit$x[row.names(bulk_X_d0) %in% index_test,]
obs_train <- fit$x[!(row.names(bulk_X_d0) %in% index_test),]

X_test <- as.matrix(bulk_X_d0[row.names(bulk_X_d0) %in% index_test,]) 
X_train <- as.matrix(bulk_X_d0[!(row.names(bulk_X_d0) %in% index_test),])

fit.x <- lm.fit(obs_train,X_train)

pred_ct_d0 <- obs_test%*%fit.x$coefficients
names(pred_ct_d0) <- gene_name
pred_ct_d0 <- data.frame(pred_ct_d0)

## for d1

fit <- lm(as.matrix(bulk_X_d1) ~ bulk_meta_d1$cell_type + bulk_meta_d1$plate_name + bulk_meta_d1$row, x=TRUE)

index_test <- c()
for (i in 1: nrow(pairs_test)){
  ix <- bulk_meta_d1$cell_type==pairs_test$cell_type[i] & bulk_meta_d1$sm_name==pairs_test$sm_name[i]
  index_test[i] <- row.names(bulk_meta_d1[ix,])
}

obs_test <- fit$x[row.names(bulk_X_d1) %in% index_test,]
obs_train <- fit$x[!(row.names(bulk_X_d1) %in% index_test),]

X_test <- as.matrix(bulk_X_d1[row.names(bulk_X_d1) %in% index_test,]) 
X_train <- as.matrix(bulk_X_d1[!(row.names(bulk_X_d1) %in% index_test),])

fit.x <- lm.fit(obs_train,X_train)

pred_ct_d1 <- obs_test%*%fit.x$coefficients
names(pred_ct_d1) <- gene_name
pred_ct_d1 <- data.frame(pred_ct_d1)

## for d2

fit <- lm(as.matrix(bulk_X_d2) ~ bulk_meta_d2$cell_type + bulk_meta_d2$plate_name + bulk_meta_d2$row, x=TRUE)

index_test <- c()
for (i in 1: nrow(pairs_test)){
  ix <- bulk_meta_d2$cell_type==pairs_test$cell_type[i] & bulk_meta_d2$sm_name==pairs_test$sm_name[i]
  index_test[i] <- row.names(bulk_meta_d2[ix,])
}

obs_test <- fit$x[row.names(bulk_X_d2) %in% index_test,]
obs_train <- fit$x[!(row.names(bulk_X_d2) %in% index_test),]

X_test <- as.matrix(bulk_X_d2[row.names(bulk_X_d2) %in% index_test,]) 
X_train <- as.matrix(bulk_X_d2[!(row.names(bulk_X_d2) %in% index_test),])

fit.x <- lm.fit(obs_train,X_train)

pred_ct_d2 <- obs_test%*%fit.x$coefficients
names(pred_ct_d2) <- gene_name
pred_ct_d2 <- data.frame(pred_ct_d2)


## full prediction result for cell model
ct_pred_full_d0 <- data.frame(d0_test_meta,pred_ct_d0)
ct_pred_full_d1 <- data.frame(d1_test_meta,pred_ct_d1)
ct_pred_full_d2 <- data.frame(d2_test_meta,pred_ct_d2)

ct_pred_full <- data.frame(rbind(ct_pred_full_d0,ct_pred_full_d1,ct_pred_full_d2))

```

### Perturbation model

```{r}
## for d0

fit <- lm(as.matrix(bulk_X_d0) ~ bulk_meta_d0$sm_name+ bulk_meta_d0$plate_name + bulk_meta_d0$row, x=TRUE)

index_test <- c()
for (i in 1: nrow(pairs_test)){
  ix <- bulk_meta_d0$cell_type==pairs_test$cell_type[i] & bulk_meta_d0$sm_name==pairs_test$sm_name[i]
  index_test[i] <- row.names(bulk_meta_d0[ix,])
}

obs_test <- fit$x[row.names(bulk_X_d0) %in% index_test,]
obs_train <- fit$x[!(row.names(bulk_X_d0) %in% index_test),]

X_test <- as.matrix(bulk_X_d0[row.names(bulk_X_d0) %in% index_test,]) 
X_train <- as.matrix(bulk_X_d0[!(row.names(bulk_X_d0) %in% index_test),])

fit.x <- lm.fit(obs_train,X_train)

temp <- fit.x$coefficients
temp[is.na(temp)] <- 0

pred_pt_d0 <- as.matrix(obs_test)%*%temp
names(pred_pt_d0) <- gene_name
pred_pt_d0 <- data.frame(pred_pt_d0)

## for d1

fit <- lm(as.matrix(bulk_X_d1) ~ bulk_meta_d1$sm_name+ bulk_meta_d1$plate_name + bulk_meta_d1$row, x=TRUE)

index_test <- c()
for (i in 1: nrow(pairs_test)){
  ix <- bulk_meta_d1$cell_type==pairs_test$cell_type[i] & bulk_meta_d1$sm_name==pairs_test$sm_name[i]
  index_test[i] <- row.names(bulk_meta_d1[ix,])
}

obs_test <- fit$x[row.names(bulk_X_d1) %in% index_test,]
obs_train <- fit$x[!(row.names(bulk_X_d1) %in% index_test),]

X_test <- as.matrix(bulk_X_d1[row.names(bulk_X_d1) %in% index_test,]) 
X_train <- as.matrix(bulk_X_d1[!(row.names(bulk_X_d1) %in% index_test),])

fit.x <- lm.fit(obs_train,X_train)

temp <- fit.x$coefficients
temp[is.na(temp)] <- 0

pred_pt_d1 <- obs_test%*%temp
names(pred_pt_d1) <- gene_name
pred_pt_d1 <- data.frame(pred_pt_d1)

## for d2

fit <- lm(as.matrix(bulk_X_d2) ~ bulk_meta_d2$sm_name+ bulk_meta_d2$plate_name + bulk_meta_d2$row, x=TRUE)

index_test <- c()
for (i in 1: nrow(pairs_test)){
  ix <- bulk_meta_d2$cell_type==pairs_test$cell_type[i] & bulk_meta_d2$sm_name==pairs_test$sm_name[i]
  index_test[i] <- row.names(bulk_meta_d2[ix,])
}

obs_test <- fit$x[row.names(bulk_X_d2) %in% index_test,]
obs_train <- fit$x[!(row.names(bulk_X_d2) %in% index_test),]

X_test <- as.matrix(bulk_X_d2[row.names(bulk_X_d2) %in% index_test,]) 
X_train <- as.matrix(bulk_X_d2[!(row.names(bulk_X_d2) %in% index_test),])

fit.x <- lm.fit(obs_train,X_train)

temp <- fit.x$coefficients
temp[is.na(temp)] <- 0

pred_pt_d2 <- obs_test%*%temp
names(pred_pt_d2) <- gene_name
pred_pt_d2 <- data.frame(pred_pt_d2)


## full prediction result for pert model
pt_pred_full_d0 <- data.frame(d0_test_meta,pred_pt_d0)
pt_pred_full_d1 <- data.frame(d1_test_meta,pred_pt_d1)
pt_pred_full_d2 <- data.frame(d2_test_meta,pred_pt_d2)

pt_pred_full <- data.frame(rbind(pt_pred_full_d0,pt_pred_full_d1,pt_pred_full_d2))
```

### Two factor model

```{r}
## for d0

fit <- lm(as.matrix(bulk_X_d0) ~ bulk_meta_d0$sm_name + bulk_meta_d0$cell_type+ bulk_meta_d0$plate_name + bulk_meta_d0$row, x=TRUE)

index_test <- c()
for (i in 1: nrow(pairs_test)){
  ix <- bulk_meta_d0$cell_type==pairs_test$cell_type[i] & bulk_meta_d0$sm_name==pairs_test$sm_name[i]
  index_test[i] <- row.names(bulk_meta_d0[ix,])
}

obs_test <- fit$x[row.names(bulk_X_d0) %in% index_test,]
obs_train <- fit$x[!(row.names(bulk_X_d0) %in% index_test),]

X_test <- as.matrix(bulk_X_d0[row.names(bulk_X_d0) %in% index_test,]) 
X_train <- as.matrix(bulk_X_d0[!(row.names(bulk_X_d0) %in% index_test),])

fit.x <- lm.fit(obs_train,X_train)

temp <- fit.x$coefficients
temp[is.na(temp)] <- 0

pred_tf_d0 <- as.matrix(obs_test)%*%temp
names(pred_tf_d0) <- gene_name
pred_tf_d0 <- data.frame(pred_tf_d0)

## for d1

fit <- lm(as.matrix(bulk_X_d1) ~ bulk_meta_d1$sm_name+bulk_meta_d1$cell_type+ bulk_meta_d1$plate_name + bulk_meta_d1$row, x=TRUE)

index_test <- c()
for (i in 1: nrow(pairs_test)){
  ix <- bulk_meta_d1$cell_type==pairs_test$cell_type[i] & bulk_meta_d1$sm_name==pairs_test$sm_name[i]
  index_test[i] <- row.names(bulk_meta_d1[ix,])
}

obs_test <- fit$x[row.names(bulk_X_d1) %in% index_test,]
obs_train <- fit$x[!(row.names(bulk_X_d1) %in% index_test),]

X_test <- as.matrix(bulk_X_d1[row.names(bulk_X_d1) %in% index_test,]) 
X_train <- as.matrix(bulk_X_d1[!(row.names(bulk_X_d1) %in% index_test),])

fit.x <- lm.fit(obs_train,X_train)

temp <- fit.x$coefficients
temp[is.na(temp)] <- 0

pred_tf_d1 <- obs_test%*%temp
names(pred_tf_d1) <- gene_name
pred_tf_d1 <- data.frame(pred_tf_d1)

## for d2

fit <- lm(as.matrix(bulk_X_d2) ~ bulk_meta_d2$sm_name+bulk_meta_d2$cell_type+ bulk_meta_d2$plate_name + bulk_meta_d2$row, x=TRUE)

index_test <- c()
for (i in 1: nrow(pairs_test)){
  ix <- bulk_meta_d2$cell_type==pairs_test$cell_type[i] & bulk_meta_d2$sm_name==pairs_test$sm_name[i]
  index_test[i] <- row.names(bulk_meta_d2[ix,])
}

obs_test <- fit$x[row.names(bulk_X_d2) %in% index_test,]
obs_train <- fit$x[!(row.names(bulk_X_d2) %in% index_test),]

X_test <- as.matrix(bulk_X_d2[row.names(bulk_X_d2) %in% index_test,]) 
X_train <- as.matrix(bulk_X_d2[!(row.names(bulk_X_d2) %in% index_test),])

fit.x <- lm.fit(obs_train,X_train)

temp <- fit.x$coefficients
temp[is.na(temp)] <- 0

pred_tf_d2 <- obs_test%*%temp
names(pred_tf_d2) <- gene_name
pred_tf_d2 <- data.frame(pred_tf_d2)


## full prediction result for pert model
tf_pred_full_d0 <- data.frame(d0_test_meta,pred_tf_d0)
tf_pred_full_d1 <- data.frame(d1_test_meta,pred_tf_d1)
tf_pred_full_d2 <- data.frame(d2_test_meta,pred_tf_d2)

tf_pred_full <- data.frame(rbind(tf_pred_full_d0,tf_pred_full_d1,tf_pred_full_d2))
```

### SIA

```{r}
## find donor action
sia_find_donor <- function(data, a.target, c.target){
  a.donor <- unique(data$sm_name[data$cell_type==c.target])
  return(a.donor)
}

## find contexts where the target action is measured
sia_current_context <- function(data, a.target){
  c.current <- unique(data$cell_type[data$sm_name==a.target])
  return(c.current)
}

## find training context, will pick donor actions as many as possible

sia_find_training <- function(data, a.donor, a.target, c.target){
  c.current <- sia_current_context(data, a.target)
  a.donor.cand <- a.donor
  a.donor.new <- c()
  while (length(c.current)>0){
    len <- rep(0,length(a.donor.cand))
    for (i in 1:length(a.donor.cand)){
      temp <- unique(data$cell_type[data$sm_name==a.donor.cand[i]])
      int <- intersect(c.current,temp)
      len[i] <- length(int)
    }
    c.temp <- intersect(c.current,unique(data$cell_type[data$sm_name==a.donor.cand[len==max(len)][1]]))
    if (length(c.temp)==0){
      break;
    }else {
      c.current <- c.temp
      a.donor.new <- append(a.donor.new, a.donor.cand[len==max(len)][1])
      a.donor.cand <- a.donor.cand[a.donor.cand!=a.donor.cand[len==max(len)][1]]
      if (length(a.donor.cand)==0){
        break;
      }
    }
  }
  l1 <- list(train=c.current, sub=a.donor.new)
  return(l1)
}

## linear regression and prediction
sia_lm <- function(a.donor.sub, c.train, data, y){
  r2 <- NA
  if (length(c.train)>0 & length(a.donor.sub)>0){
    y.train <- c()
    for (i in 1: length(c.train)){
      y.train <- append(y.train,as.vector(y[data$sm_name==a.target & data$cell_type==c.train[i],]))
    }
    Y.train <- matrix(nrow = length(a.donor.sub), ncol=length(y.train))
    for (i in 1: length(a.donor.sub)){
      y.temp <- c()
      a.temp <- a.donor.sub[i]
      for (j in 1: length(c.train)){
        y.temp <- append(y.temp,as.vector(y[data$sm_name==a.temp & data$cell_type==c.train[j],]))
      }
      Y.train[i,] <- y.temp
    }
    ## Find Y.test
    Y.test <- matrix(ncol = ncol(y),nrow=length(a.donor.sub))
    for (i in 1:length(a.donor.sub)){
      Y.test[i,] <- as.vector(y[data$cell_type==c.target & data$sm_name==a.donor.sub[i],])
    }
    ## regression and prediction
    rp <- y.train
    X <- t(Y.train)
    fit <- lm(rp~X)
    int <- rep(1,ncol(Y.test))
    X.test <- as.matrix(cbind(int,t(Y.test)))
    pred <- X.test%*%as.matrix(fit$coefficients)
  }else{
    pred <- rep(0,ncol(data)-6)
  }
  return(pred)
}
```

```{r}
### batch effect removal for SIA

fit0 <- lm(as.matrix(bulk_X_d0) ~ bulk_meta_d0$sm_name + bulk_meta_d0$cell_type+ bulk_meta_d0$plate_name + bulk_meta_d0$row, x=TRUE)

index_test <- c()
for (i in 1: nrow(pairs_test)){
  ix <- bulk_meta_d0$cell_type==pairs_test$cell_type[i] & bulk_meta_d0$sm_name==pairs_test$sm_name[i]
  index_test[i] <- row.names(bulk_meta_d0[ix,])
}

obs_test <- fit0$x[row.names(bulk_X_d0) %in% index_test,]
obs_train <- fit0$x[!(row.names(bulk_X_d0) %in% index_test),]

X_test <- as.matrix(bulk_X_d0[row.names(bulk_X_d0) %in% index_test,]) 
X_train <- as.matrix(bulk_X_d0[!(row.names(bulk_X_d0) %in% index_test),])

fit0.x <- lm.fit(obs_train,X_train)

coef_pl2 <- fit0.x$coefficients[152,]
coef_rB <- fit0.x$coefficients[153,]
coef_rC <- fit0.x$coefficients[154,]
coef_rD <- fit0.x$coefficients[155,]
coef_rE <- fit0.x$coefficients[156,]
coef_rF <- fit0.x$coefficients[157,]
coef_rG <- fit0.x$coefficients[158,]
coef_rH <- fit0.x$coefficients[159,]

bulk_X_d0_sia <- bulk_X_d0
bulk_X_d0_sia[bulk_meta_d0$plate_name=="plate_2",] <- bulk_X_d0_sia[bulk_meta_d0$plate_name=="plate_2",]-coef_pl2
bulk_X_d0_sia[bulk_meta_d0$row=="B",] <- bulk_X_d0_sia[bulk_meta_d0$row=="B",]-coef_rB
bulk_X_d0_sia[bulk_meta_d0$row=="C",] <- bulk_X_d0_sia[bulk_meta_d0$row=="C",]-coef_rC
bulk_X_d0_sia[bulk_meta_d0$row=="D",] <- bulk_X_d0_sia[bulk_meta_d0$row=="D",]-coef_rD
bulk_X_d0_sia[bulk_meta_d0$row=="E",] <- bulk_X_d0_sia[bulk_meta_d0$row=="E",]-coef_rE
bulk_X_d0_sia[bulk_meta_d0$row=="F",] <- bulk_X_d0_sia[bulk_meta_d0$row=="F",]-coef_rF
bulk_X_d0_sia[bulk_meta_d0$row=="G",] <- bulk_X_d0_sia[bulk_meta_d0$row=="G",]-coef_rG
bulk_X_d0_sia[bulk_meta_d0$row=="H",] <- bulk_X_d0_sia[bulk_meta_d0$row=="H",]-coef_rH

#############

fit1 <- lm(as.matrix(bulk_X_d1) ~ bulk_meta_d1$sm_name + bulk_meta_d1$cell_type+ bulk_meta_d1$plate_name + bulk_meta_d1$row, x=TRUE)

index_test <- c()
for (i in 1: nrow(pairs_test)){
  ix <- bulk_meta_d1$cell_type==pairs_test$cell_type[i] & bulk_meta_d1$sm_name==pairs_test$sm_name[i]
  index_test[i] <- row.names(bulk_meta_d1[ix,])
}

obs_test <- fit1$x[row.names(bulk_X_d1) %in% index_test,]
obs_train <- fit1$x[!(row.names(bulk_X_d1) %in% index_test),]

X_test <- as.matrix(bulk_X_d1[row.names(bulk_X_d1) %in% index_test,]) 
X_train <- as.matrix(bulk_X_d1[!(row.names(bulk_X_d1) %in% index_test),])

fit1.x <- lm.fit(obs_train,X_train)

coef_pl5 <- fit1.x$coefficients[152,]
coef_rB <- fit1.x$coefficients[153,]
coef_rC <- fit1.x$coefficients[154,]
coef_rD <- fit1.x$coefficients[155,]
coef_rE <- fit1.x$coefficients[156,]
coef_rF <- fit1.x$coefficients[157,]
coef_rG <- fit1.x$coefficients[158,]
coef_rH <- fit1.x$coefficients[159,]

bulk_X_d1_sia <- bulk_X_d1
bulk_X_d1_sia[bulk_meta_d1$plate_name=="plate_5",] <- bulk_X_d1_sia[bulk_meta_d1$plate_name=="plate_5",]-coef_pl5
bulk_X_d1_sia[bulk_meta_d1$row=="B",] <- bulk_X_d1_sia[bulk_meta_d1$row=="B",]-coef_rB
bulk_X_d1_sia[bulk_meta_d1$row=="C",] <- bulk_X_d1_sia[bulk_meta_d1$row=="C",]-coef_rC
bulk_X_d1_sia[bulk_meta_d1$row=="D",] <- bulk_X_d1_sia[bulk_meta_d1$row=="D",]-coef_rD
bulk_X_d1_sia[bulk_meta_d1$row=="E",] <- bulk_X_d1_sia[bulk_meta_d1$row=="E",]-coef_rE
bulk_X_d1_sia[bulk_meta_d1$row=="F",] <- bulk_X_d1_sia[bulk_meta_d1$row=="F",]-coef_rF
bulk_X_d1_sia[bulk_meta_d1$row=="G",] <- bulk_X_d1_sia[bulk_meta_d1$row=="G",]-coef_rG
bulk_X_d1_sia[bulk_meta_d1$row=="H",] <- bulk_X_d1_sia[bulk_meta_d1$row=="H",]-coef_rH

#########################

fit2 <- lm(as.matrix(bulk_X_d2) ~ bulk_meta_d2$sm_name + bulk_meta_d2$cell_type+ bulk_meta_d2$plate_name + bulk_meta_d2$row, x=TRUE)

index_test <- c()
for (i in 1: nrow(pairs_test)){
  ix <- bulk_meta_d2$cell_type==pairs_test$cell_type[i] & bulk_meta_d2$sm_name==pairs_test$sm_name[i]
  index_test[i] <- row.names(bulk_meta_d2[ix,])
}

obs_test <- fit2$x[row.names(bulk_X_d2) %in% index_test,]
obs_train <- fit2$x[!(row.names(bulk_X_d2) %in% index_test),]

X_test <- as.matrix(bulk_X_d2[row.names(bulk_X_d2) %in% index_test,]) 
X_train <- as.matrix(bulk_X_d2[!(row.names(bulk_X_d2) %in% index_test),])

fit2.x <- lm.fit(obs_train,X_train)

coef_pl4 <- fit2.x$coefficients[152,]
coef_rB <- fit2.x$coefficients[153,]
coef_rC <- fit2.x$coefficients[154,]
coef_rD <- fit2.x$coefficients[155,]
coef_rE <- fit2.x$coefficients[156,]
coef_rF <- fit2.x$coefficients[157,]
coef_rG <- fit2.x$coefficients[158,]
coef_rH <- fit2.x$coefficients[159,]

bulk_X_d2_sia <- bulk_X_d2
bulk_X_d2_sia[bulk_meta_d2$plate_name=="plate_4",] <- bulk_X_d2_sia[bulk_meta_d2$plate_name=="plate_4",]-coef_pl4
bulk_X_d2_sia[bulk_meta_d2$row=="B",] <- bulk_X_d2_sia[bulk_meta_d2$row=="B",]-coef_rB
bulk_X_d2_sia[bulk_meta_d2$row=="C",] <- bulk_X_d2_sia[bulk_meta_d2$row=="C",]-coef_rC
bulk_X_d2_sia[bulk_meta_d2$row=="D",] <- bulk_X_d2_sia[bulk_meta_d2$row=="D",]-coef_rD
bulk_X_d2_sia[bulk_meta_d2$row=="E",] <- bulk_X_d2_sia[bulk_meta_d2$row=="E",]-coef_rE
bulk_X_d2_sia[bulk_meta_d2$row=="F",] <- bulk_X_d2_sia[bulk_meta_d2$row=="F",]-coef_rF
bulk_X_d2_sia[bulk_meta_d2$row=="G",] <- bulk_X_d2_sia[bulk_meta_d2$row=="G",]-coef_rG
bulk_X_d2_sia[bulk_meta_d2$row=="H",] <- bulk_X_d2_sia[bulk_meta_d2$row=="H",]-coef_rH
```

```{r}
View(control[control$cell_type=="T regular cells"])
```

```{r}
d0_full <- data.frame(bulk_meta_d0,bulk_X_d0_sia)
d1_full <- data.frame(bulk_meta_d1,bulk_X_d1_sia)
d2_full <- data.frame(bulk_meta_d2,bulk_X_d2_sia)

index <- c()
for (i in 1: nrow(pairs_train)){
  ix <- bulk_meta_d0$cell_type==pairs_train$cell_type[i] & bulk_meta_d0$sm_name==pairs_train$sm_name[i]
  index[i] <- row.names(bulk_meta_d0[ix,])
}

d0_train_X_sia <- bulk_X_d0_sia[row.names(bulk_X_d0) %in% index,]

index <- c()
for (i in 1: nrow(pairs_train)){
  ix <- bulk_meta_d1$cell_type==pairs_train$cell_type[i] & bulk_meta_d1$sm_name==pairs_train$sm_name[i]
  index[i] <- row.names(bulk_meta_d1[ix,])
}

d1_train_X_sia <- bulk_X_d1[row.names(bulk_X_d1_sia) %in% index,]

index <- c()
for (i in 1: nrow(pairs_train)){
  ix <- bulk_meta_d2$cell_type==pairs_train$cell_type[i] & bulk_meta_d2$sm_name==pairs_train$sm_name[i]
  index[i] <- row.names(bulk_meta_d2[ix,])
}

d2_train_X_sia <- bulk_X_d2[row.names(bulk_X_d2_sia) %in% index,]

d0_test_full <- data.frame(d0_test_meta,d0_test_X)
d0_train_full_sia <- data.frame(d0_train_meta,d0_train_X_sia)

d1_test_full <- data.frame(d1_test_meta,d0_test_X)
d1_train_full_sia <- data.frame(d1_train_meta,d0_train_X_sia)

d2_test_full <- data.frame(d2_test_meta,d2_test_X)
d2_train_full_sia <- data.frame(d2_train_meta,d2_train_X_sia)


pred_sia_d0 <- matrix(ncol = ncol(d0_test_X), nrow = nrow(d0_test_X))
for (i in 1: nrow(d0_test_X)){
  a.target <- d0_test_full[i,]$sm_name
  c.target <- d0_test_full[i,]$cell_type
  subset_searching <- d0_train_full_sia
  y_searching <- as.matrix(subset_searching[,-(1:6)])
  a <- sia_find_donor(subset_searching,a.target,c.target)
  b <- sia_find_training(subset_searching,a,a.target,c.target)
  pred_sia_d0[i,] <- sia_lm(b$sub,b$train,subset_searching,y_searching)
}

pred_sia_d0 <- data.frame(pred_sia_d0)
names(pred_sia_d0) <- gene_name

pred_sia_d1 <- matrix(ncol = ncol(d1_test_X), nrow = nrow(d1_test_X))
for (i in 1: nrow(d1_test_X)){
  a.target <- d1_test_full[i,]$sm_name
  c.target <- d1_test_full[i,]$cell_type
  subset_searching <- d1_train_full_sia
  y_searching <- as.matrix(subset_searching[,-(1:6)])
  a <- sia_find_donor(subset_searching,a.target,c.target)
  b <- sia_find_training(subset_searching,a,a.target,c.target)
  pred_sia_d1[i,] <- sia_lm(b$sub,b$train,subset_searching,y_searching)
}

pred_sia_d1 <- data.frame(pred_sia_d1)
names(pred_sia_d1) <- gene_name


pred_sia_d2 <- matrix(ncol = ncol(d2_test_X), nrow = nrow(d2_test_X))
for (i in 1: nrow(d2_test_X)){
  a.target <- d2_test_full[i,]$sm_name
  c.target <- d2_test_full[i,]$cell_type
  subset_searching <- d2_train_full_sia
  y_searching <- as.matrix(subset_searching[,-(1:6)])
  a <- sia_find_donor(subset_searching,a.target,c.target)
  b <- sia_find_training(subset_searching,a,a.target,c.target)
  pred_sia_d2[i,] <- sia_lm(b$sub,b$train,subset_searching,y_searching)
}

pred_sia_d2 <- data.frame(pred_sia_d2)
names(pred_sia_d2) <- gene_name

#################

coef_pl2 <- fit0.x$coefficients[152,]
coef_rB <- fit0.x$coefficients[153,]
coef_rC <- fit0.x$coefficients[154,]
coef_rD <- fit0.x$coefficients[155,]
coef_rE <- fit0.x$coefficients[156,]
coef_rF <- fit0.x$coefficients[157,]
coef_rG <- fit0.x$coefficients[158,]
coef_rH <- fit0.x$coefficients[159,]

pred_sia_d0_adj <- pred_sia_d0
pred_sia_d0_adj[d0_test_meta$plate_name=="plate_2",] <- pred_sia_d0_adj[d0_test_meta$plate_name=="plate_2",]+coef_pl2
pred_sia_d0_adj[d0_test_meta$row=="B",] <- pred_sia_d0_adj[d0_test_meta$row=="B",]+coef_rB
pred_sia_d0_adj[d0_test_meta$row=="C",] <- pred_sia_d0_adj[d0_test_meta$row=="C",]+coef_rC
pred_sia_d0_adj[d0_test_meta$row=="D",] <- pred_sia_d0_adj[d0_test_meta$row=="D",]+coef_rD
pred_sia_d0_adj[d0_test_meta$row=="E",] <- pred_sia_d0_adj[d0_test_meta$row=="E",]+coef_rE
pred_sia_d0_adj[d0_test_meta$row=="F",] <- pred_sia_d0_adj[d0_test_meta$row=="F",]+coef_rF
pred_sia_d0_adj[d0_test_meta$row=="G",] <- pred_sia_d0_adj[d0_test_meta$row=="G",]+coef_rG
pred_sia_d0_adj[d0_test_meta$row=="H",] <- pred_sia_d0_adj[d0_test_meta$row=="H",]+coef_rH

###################

coef_pl5 <- fit1.x$coefficients[152,]
coef_rB <- fit1.x$coefficients[153,]
coef_rC <- fit1.x$coefficients[154,]
coef_rD <- fit1.x$coefficients[155,]
coef_rE <- fit1.x$coefficients[156,]
coef_rF <- fit1.x$coefficients[157,]
coef_rG <- fit1.x$coefficients[158,]
coef_rH <- fit1.x$coefficients[159,]

pred_sia_d1_adj <- pred_sia_d1
pred_sia_d1_adj[d1_test_meta$plate_name=="plate_5",] <- pred_sia_d1_adj[d1_test_meta$plate_name=="plate_5",]+coef_pl5
pred_sia_d1_adj[d1_test_meta$row=="B",] <- pred_sia_d1_adj[d1_test_meta$row=="B",]+coef_rB
pred_sia_d1_adj[d1_test_meta$row=="C",] <- pred_sia_d1_adj[d1_test_meta$row=="C",]+coef_rC
pred_sia_d1_adj[d1_test_meta$row=="D",] <- pred_sia_d1_adj[d1_test_meta$row=="D",]+coef_rD
pred_sia_d1_adj[d1_test_meta$row=="E",] <- pred_sia_d1_adj[d1_test_meta$row=="E",]+coef_rE
pred_sia_d1_adj[d1_test_meta$row=="F",] <- pred_sia_d1_adj[d1_test_meta$row=="F",]+coef_rF
pred_sia_d1_adj[d1_test_meta$row=="G",] <- pred_sia_d1_adj[d1_test_meta$row=="G",]+coef_rG
pred_sia_d1_adj[d1_test_meta$row=="H",] <- pred_sia_d1_adj[d1_test_meta$row=="H",]+coef_rH

######################

coef_pl4 <- fit2.x$coefficients[152,]
coef_rB <- fit2.x$coefficients[153,]
coef_rC <- fit2.x$coefficients[154,]
coef_rD <- fit2.x$coefficients[155,]
coef_rE <- fit2.x$coefficients[156,]
coef_rF <- fit2.x$coefficients[157,]
coef_rG <- fit2.x$coefficients[158,]
coef_rH <- fit2.x$coefficients[159,]

pred_sia_d2_adj <- pred_sia_d2
pred_sia_d2_adj[d2_test_meta$plate_name=="plate_4",] <- pred_sia_d2_adj[d2_test_meta$plate_name=="plate_4",]+coef_pl4
pred_sia_d2_adj[d2_test_meta$row=="B",] <- pred_sia_d2_adj[d2_test_meta$row=="B",]+coef_rB
pred_sia_d2_adj[d2_test_meta$row=="C",] <- pred_sia_d2_adj[d2_test_meta$row=="C",]+coef_rC
pred_sia_d2_adj[d2_test_meta$row=="D",] <- pred_sia_d2_adj[d2_test_meta$row=="D",]+coef_rD
pred_sia_d2_adj[d2_test_meta$row=="E",] <- pred_sia_d2_adj[d2_test_meta$row=="E",]+coef_rE
pred_sia_d2_adj[d2_test_meta$row=="F",] <- pred_sia_d2_adj[d2_test_meta$row=="F",]+coef_rF
pred_sia_d2_adj[d2_test_meta$row=="G",] <- pred_sia_d2_adj[d2_test_meta$row=="G",]+coef_rG
pred_sia_d2_adj[d2_test_meta$row=="H",] <- pred_sia_d2_adj[d2_test_meta$row=="H",]+coef_rH

sia_pred_full_d0 <- data.frame(d0_test_meta,pred_sia_d0_adj)
sia_pred_full_d1 <- data.frame(d1_test_meta,pred_sia_d1_adj)
sia_pred_full_d2 <- data.frame(d2_test_meta,pred_sia_d2_adj)

sia_pred_full <- data.frame(rbind(sia_pred_full_d0,sia_pred_full_d1,sia_pred_full_d2))

```

## Measure the model performance by R2

### Cell model prediction

```{r}
r2_ct_d0 <- c()
for (i in 1:nrow(pairs_test)){
  ix <- bulk_meta_d0$cell_type==pairs_test$cell_type[i] & bulk_meta_d0$sm_name==pairs_test$sm_name[i]
  obs_expr <- as.numeric(bulk_X_d0[ix,])
  ix_n <- ct_pred_full_d0$cell_type==pairs_test$cell_type[i] & ct_pred_full_d0$sm_name==pairs_test$sm_name[i]
  pred_expr <- as.numeric(ct_pred_full_d0[ix_n,-(1:6)])
  r2_ct_d0[i] <- round(cor(obs_expr,pred_expr)^2,2)
  
  dt <- data.frame(gene_name,obs_expr,pred_expr)
  names(dt) <- c("gene_name","in_vitro_mean","in_silico_prediction")
  
  p <- ggplot(dt, aes(x=in_vitro_mean, y=in_silico_prediction)) + 
  geom_point(shape=2,alpha=0.8, color="blue")+
  geom_smooth(method=lm, na.rm = TRUE,colour="black")+
  xlab("in_vitro_mean") + ylab("in_silico_prediction")+ ggtitle(paste0(pairs_test$cell_type[i],"_",pairs_test$sm_name[i]))+
  labs(tag = paste0("R2=",r2_ct_d0[i]))+ theme(plot.tag.position = "topright")
  print(p)
}
```

```{r}
r2_ct_d1 <- c()
for (i in 1:nrow(pairs_test)){
  ix <- bulk_meta_d1$cell_type==pairs_test$cell_type[i] & bulk_meta_d1$sm_name==pairs_test$sm_name[i]
  obs_expr <- as.numeric(bulk_X_d1[ix,])
  ix_n <- ct_pred_full_d1$cell_type==pairs_test$cell_type[i] & ct_pred_full_d1$sm_name==pairs_test$sm_name[i]
  pred_expr <- as.numeric(ct_pred_full_d1[ix_n,-(1:6)])
  r2_ct_d1[i] <- round(cor(obs_expr,pred_expr)^2,2)
  
  dt <- data.frame(gene_name,obs_expr,pred_expr)
  names(dt) <- c("gene_name","in_vitro_mean","in_silico_prediction")
  
  p <- ggplot(dt, aes(x=in_vitro_mean, y=in_silico_prediction)) + 
  geom_point(shape=2,alpha=0.8, color="blue")+
  geom_smooth(method=lm, na.rm = TRUE,colour="black")+
  xlab("in_vitro_mean") + ylab("in_silico_prediction")+ ggtitle(paste0(pairs_test$cell_type[i],"_",pairs_test$sm_name[i]))+
  labs(tag = paste0("R2=",r2_ct_d1[i]))+ theme(plot.tag.position = "topright")
  print(p)
}
```

```{r}
r2_ct_d2 <- c()
for (i in 1:nrow(pairs_test)){
  ix <- bulk_meta_d2$cell_type==pairs_test$cell_type[i] & bulk_meta_d2$sm_name==pairs_test$sm_name[i]
  obs_expr <- as.numeric(bulk_X_d2[ix,])
  ix_n <- ct_pred_full_d2$cell_type==pairs_test$cell_type[i] & ct_pred_full_d2$sm_name==pairs_test$sm_name[i]
  pred_expr <- as.numeric(ct_pred_full_d2[ix_n,-(1:6)])
  r2_ct_d2[i] <- round(cor(obs_expr,pred_expr)^2,2)
  
  dt <- data.frame(gene_name,obs_expr,pred_expr)
  names(dt) <- c("gene_name","in_vitro_mean","in_silico_prediction")
  
  p <- ggplot(dt, aes(x=in_vitro_mean, y=in_silico_prediction)) + 
  geom_point(shape=2,alpha=0.8, color="blue")+
  geom_smooth(method=lm, na.rm = TRUE,colour="black")+
  xlab("in_vitro_mean") + ylab("in_silico_prediction")+ ggtitle(paste0(pairs_test$cell_type[i],"_",pairs_test$sm_name[i]))+
  labs(tag = paste0("R2=",r2_ct_d2[i]))+ theme(plot.tag.position = "topright")
  print(p)
}
```

### Perturbation model prediction

```{r}
r2_pt_d0 <- c()
for (i in 1:nrow(pairs_test)){
  ix <- bulk_meta_d0$cell_type==pairs_test$cell_type[i] & bulk_meta_d0$sm_name==pairs_test$sm_name[i]
  obs_expr <- as.numeric(bulk_X_d0[ix,])
  ix_n <- pt_pred_full_d0$cell_type==pairs_test$cell_type[i] & pt_pred_full_d0$sm_name==pairs_test$sm_name[i]
  pred_expr <- as.numeric(pt_pred_full_d0[ix_n,-(1:6)])
  r2_pt_d0[i] <- round(cor(obs_expr,pred_expr)^2,2)
  
  dt <- data.frame(gene_name,obs_expr,pred_expr)
  names(dt) <- c("gene_name","in_vitro_mean","in_silico_prediction")
  
  p <- ggplot(dt, aes(x=in_vitro_mean, y=in_silico_prediction)) + 
  geom_point(shape=2,alpha=0.8, color="blue")+
  geom_smooth(method=lm, na.rm = TRUE,colour="black")+
  xlab("in_vitro_mean") + ylab("in_silico_prediction")+ ggtitle(paste0(pairs_test$cell_type[i],"_",pairs_test$sm_name[i]))+
  labs(tag = paste0("R2=",r2_pt_d0[i]))+ theme(plot.tag.position = "topright")
  print(p)
}
```

```{r}
r2_pt_d1 <- c()
for (i in 1:nrow(pairs_test)){
  ix <- bulk_meta_d1$cell_type==pairs_test$cell_type[i] & bulk_meta_d1$sm_name==pairs_test$sm_name[i]
  obs_expr <- as.numeric(bulk_X_d1[ix,])
  ix_n <- pt_pred_full_d1$cell_type==pairs_test$cell_type[i] & pt_pred_full_d1$sm_name==pairs_test$sm_name[i]
  pred_expr <- as.numeric(pt_pred_full_d1[ix_n,-(1:6)])
  r2_pt_d1[i] <- round(cor(obs_expr,pred_expr)^2,2)
  
  dt <- data.frame(gene_name,obs_expr,pred_expr)
  names(dt) <- c("gene_name","in_vitro_mean","in_silico_prediction")
  
  p <- ggplot(dt, aes(x=in_vitro_mean, y=in_silico_prediction)) + 
  geom_point(shape=2,alpha=0.8, color="blue")+
  geom_smooth(method=lm, na.rm = TRUE,colour="black")+
  xlab("in_vitro_mean") + ylab("in_silico_prediction")+ ggtitle(paste0(pairs_test$cell_type[i],"_",pairs_test$sm_name[i]))+
  labs(tag = paste0("R2=",r2_pt_d1[i]))+ theme(plot.tag.position = "topright")
  print(p)
}
```

```{r}
r2_pt_d2 <- c()
for (i in 1:nrow(pairs_test)){
  ix <- bulk_meta_d2$cell_type==pairs_test$cell_type[i] & bulk_meta_d2$sm_name==pairs_test$sm_name[i]
  obs_expr <- as.numeric(bulk_X_d2[ix,])
  ix_n <- pt_pred_full_d2$cell_type==pairs_test$cell_type[i] & pt_pred_full_d2$sm_name==pairs_test$sm_name[i]
  pred_expr <- as.numeric(pt_pred_full_d2[ix_n,-(1:6)])
  r2_pt_d2[i] <- round(cor(obs_expr,pred_expr)^2,2)
  
  dt <- data.frame(gene_name,obs_expr,pred_expr)
  names(dt) <- c("gene_name","in_vitro_mean","in_silico_prediction")
  
  p <- ggplot(dt, aes(x=in_vitro_mean, y=in_silico_prediction)) + 
  geom_point(shape=2,alpha=0.8, color="blue")+
  geom_smooth(method=lm, na.rm = TRUE,colour="black")+
  xlab("in_vitro_mean") + ylab("in_silico_prediction")+ ggtitle(paste0(pairs_test$cell_type[i],"_",pairs_test$sm_name[i]))+
  labs(tag = paste0("R2=",r2_pt_d2[i]))+ theme(plot.tag.position = "topright")
  print(p)
}
```

### Two factor model prediction

```{r}
r2_tf_d0 <- c()
for (i in 1:nrow(pairs_test)){
  ix <- bulk_meta_d0$cell_type==pairs_test$cell_type[i] & bulk_meta_d0$sm_name==pairs_test$sm_name[i]
  obs_expr <- as.numeric(bulk_X_d0[ix,])
  ix_n <- tf_pred_full_d0$cell_type==pairs_test$cell_type[i] & tf_pred_full_d0$sm_name==pairs_test$sm_name[i]
  pred_expr <- as.numeric(tf_pred_full_d0[ix_n,-(1:6)])
  r2_tf_d0[i] <- round(cor(obs_expr,pred_expr)^2,2)
  
  dt <- data.frame(gene_name,obs_expr,pred_expr)
  names(dt) <- c("gene_name","in_vitro_mean","in_silico_prediction")
  
  p <- ggplot(dt, aes(x=in_vitro_mean, y=in_silico_prediction)) + 
  geom_point(shape=2,alpha=0.8, color="blue")+
  geom_smooth(method=lm, na.rm = TRUE,colour="black")+
  xlab("in_vitro_mean") + ylab("in_silico_prediction")+ ggtitle(paste0(pairs_test$cell_type[i],"_",pairs_test$sm_name[i]))+
  labs(tag = paste0("R2=",r2_tf_d0[i]))+ theme(plot.tag.position = "topright")
  print(p)
}

```

```{r}
r2_tf_d1 <- c()
for (i in 1:nrow(pairs_test)){
  ix <- bulk_meta_d1$cell_type==pairs_test$cell_type[i] & bulk_meta_d1$sm_name==pairs_test$sm_name[i]
  obs_expr <- as.numeric(bulk_X_d1[ix,])
  ix_n <- tf_pred_full_d1$cell_type==pairs_test$cell_type[i] & tf_pred_full_d1$sm_name==pairs_test$sm_name[i]
  pred_expr <- as.numeric(tf_pred_full_d1[ix_n,-(1:6)])
  r2_tf_d1[i] <- round(cor(obs_expr,pred_expr)^2,2)
  
  dt <- data.frame(gene_name,obs_expr,pred_expr)
  names(dt) <- c("gene_name","in_vitro_mean","in_silico_prediction")
  
  p <- ggplot(dt, aes(x=in_vitro_mean, y=in_silico_prediction)) + 
  geom_point(shape=2,alpha=0.8, color="blue")+
  geom_smooth(method=lm, na.rm = TRUE,colour="black")+
  xlab("in_vitro_mean") + ylab("in_silico_prediction")+ ggtitle(paste0(pairs_test$cell_type[i],"_",pairs_test$sm_name[i]))+
  labs(tag = paste0("R2=",r2_tf_d1[i]))+ theme(plot.tag.position = "topright")
  print(p)
}

```

```{r}
r2_tf_d2 <- c()
for (i in 1:nrow(pairs_test)){
  ix <- bulk_meta_d2$cell_type==pairs_test$cell_type[i] & bulk_meta_d2$sm_name==pairs_test$sm_name[i]
  obs_expr <- as.numeric(bulk_X_d2[ix,])
  ix_n <- tf_pred_full_d2$cell_type==pairs_test$cell_type[i] & tf_pred_full_d2$sm_name==pairs_test$sm_name[i]
  pred_expr <- as.numeric(tf_pred_full_d2[ix_n,-(1:6)])
  r2_tf_d2[i] <- round(cor(obs_expr,pred_expr)^2,2)
  
  dt <- data.frame(gene_name,obs_expr,pred_expr)
  names(dt) <- c("gene_name","in_vitro_mean","in_silico_prediction")
  
  p <- ggplot(dt, aes(x=in_vitro_mean, y=in_silico_prediction)) + 
  geom_point(shape=2,alpha=0.8, color="blue")+
  geom_smooth(method=lm, na.rm = TRUE,colour="black")+
  xlab("in_vitro_mean") + ylab("in_silico_prediction")+ ggtitle(paste0(pairs_test$cell_type[i],"_",pairs_test$sm_name[i]))+
  labs(tag = paste0("R2=",r2_tf_d2[i]))+ theme(plot.tag.position = "topright")
  print(p)
}

```

```{r}
## Something is not right with T regulatory cells and T cells CD8+
View(control[control$cell_type=="T regulatory cells" & control$donor_id=="donor_0",1:6])
View(control[control$cell_type=="T regulatory cells" & control$donor_id=="donor_1",1:6])
View(control[control$cell_type=="T regulatory cells" & control$donor_id=="donor_2",1:6])

View(control[control$cell_type=="NK cells" & control$donor_id=="donor_0",1:6])
```

### SIA prediction

```{r}
r2_sia_d0 <- c()
for (i in 1:nrow(pairs_test)){
  ix <- bulk_meta_d0$cell_type==pairs_test$cell_type[i] & bulk_meta_d0$sm_name==pairs_test$sm_name[i]
  obs_expr <- as.numeric(bulk_X_d0[ix,])
  ix_n <- sia_pred_full_d0$cell_type==pairs_test$cell_type[i] & sia_pred_full_d0$sm_name==pairs_test$sm_name[i]
  pred_expr <- as.numeric(sia_pred_full_d0[ix_n,-(1:6)])
  r2_sia_d0[i] <- round(cor(obs_expr,pred_expr)^2,2)
  
  dt <- data.frame(gene_name,obs_expr,pred_expr)
  names(dt) <- c("gene_name","in_vitro_mean","in_silico_prediction")
  
  p <- ggplot(dt, aes(x=in_vitro_mean, y=in_silico_prediction)) + 
  geom_point(shape=2,alpha=0.8, color="blue")+
  geom_smooth(method=lm, na.rm = TRUE,colour="black")+
  xlab("in_vitro_mean") + ylab("in_silico_prediction")+ ggtitle(paste0(pairs_test$cell_type[i],"_",pairs_test$sm_name[i]))+
  labs(tag = paste0("R2=",r2_sia_d0[i]))+ theme(plot.tag.position = "topright")
  print(p)
}
```

```{r}
r2_sia_d1 <- c()
for (i in 1:nrow(pairs_test)){
  ix <- bulk_meta_d1$cell_type==pairs_test$cell_type[i] & bulk_meta_d1$sm_name==pairs_test$sm_name[i]
  obs_expr <- as.numeric(bulk_X_d1[ix,])
  ix_n <- sia_pred_full_d1$cell_type==pairs_test$cell_type[i] & sia_pred_full_d1$sm_name==pairs_test$sm_name[i]
  pred_expr <- as.numeric(sia_pred_full_d1[ix_n,-(1:6)])
  r2_sia_d1[i] <- round(cor(obs_expr,pred_expr)^2,2)
  
  dt <- data.frame(gene_name,obs_expr,pred_expr)
  names(dt) <- c("gene_name","in_vitro_mean","in_silico_prediction")
  
  p <- ggplot(dt, aes(x=in_vitro_mean, y=in_silico_prediction)) + 
  geom_point(shape=2,alpha=0.8, color="blue")+
  geom_smooth(method=lm, na.rm = TRUE,colour="black")+
  xlab("in_vitro_mean") + ylab("in_silico_prediction")+ ggtitle(paste0(pairs_test$cell_type[i],"_",pairs_test$sm_name[i]))+
  labs(tag = paste0("R2=",r2_sia_d1[i]))+ theme(plot.tag.position = "topright")
  print(p)
}
```

```{r}
r2_sia_d2 <- c()
for (i in 1:nrow(pairs_test)){
  ix <- bulk_meta_d2$cell_type==pairs_test$cell_type[i] & bulk_meta_d2$sm_name==pairs_test$sm_name[i]
  obs_expr <- as.numeric(bulk_X_d2[ix,])
  ix_n <- sia_pred_full_d2$cell_type==pairs_test$cell_type[i] & sia_pred_full_d2$sm_name==pairs_test$sm_name[i]
  pred_expr <- as.numeric(sia_pred_full_d2[ix_n,-(1:6)])
  r2_sia_d2[i] <- round(cor(obs_expr,pred_expr)^2,2)
  
  dt <- data.frame(gene_name,obs_expr,pred_expr)
  names(dt) <- c("gene_name","in_vitro_mean","in_silico_prediction")
  
  p <- ggplot(dt, aes(x=in_vitro_mean, y=in_silico_prediction)) + 
  geom_point(shape=2,alpha=0.8, color="blue")+
  geom_smooth(method=lm, na.rm = TRUE,colour="black")+
  xlab("in_vitro_mean") + ylab("in_silico_prediction")+ ggtitle(paste0(pairs_test$cell_type[i],"_",pairs_test$sm_name[i]))+
  labs(tag = paste0("R2=",r2_sia_d2[i]))+ theme(plot.tag.position = "topright")
  print(p)
}
```

## DE analysis with in silico predictions

### Get DE result for cell model prediction

```{r}
## add control into the prediction dataset
control <- bulk_full[bulk_full$sm_name=="DMSO" | bulk_full$sm_name == "Dabrafenib" | bulk_full$sm_name == "Belinostat", ]

ct_DE <- data.frame(rbind(control,ct_pred_full))
pt_DE <- data.frame(rbind(control,pt_pred_full))
tf_DE <- data.frame(rbind(control,tf_pred_full))
sia_DE <- data.frame(rbind(control,sia_pred_full))

pert <- unique(ct_DE$sm_name)
Rpert_uni <- c(1:length(pert))

Rpert <- c()
for (i in 1:nrow(ct_DE)){
  Rpert[i] <- Rpert_uni[which(ct_DE$sm_name[i]==pert)]
}
```

```{r}
library(data.table)
## Use limma for DE analysis

## cell type model prediction
DE_ct_result <- list()
for (i in cell_type_name){
  ct_DE_temp <- ct_DE[ct_DE$cell_type==i,]
  Rpert_temp <- as.factor(Rpert[ct_DE$cell_type==i])
  donor_id <- ct_DE_temp$donor_id
  plate_name <- ct_DE_temp$plate_name
  row <- ct_DE_temp$row
  counts <- data.frame(t(ct_DE_temp[,-(1:6)]))
  counts[counts<0] <- 0
  d1 <- DGEList(counts)
  d0 <- calcNormFactors(d0)

  mm <- model.matrix(~0+Rpert_temp+donor_id+plate_name+row)
  y <- voom(d1, mm, plot=TRUE)
  fit <- lmFit(y, mm)
  
  grp_temp <- colnames(coef(fit))[colnames(coef(fit)) %like% "Rpert" & colnames(coef(fit)) != "Rpert_temp2"]
  result_ct_list <- list()
  for (j in 1:length(grp_temp)){
    contr <- makeContrasts(contrasts = paste0(grp_temp[j],"-","Rpert_temp2"), levels = colnames(coef(fit)))
    tmp <- contrasts.fit(fit, contr)
    tmp <- eBayes(tmp)
    result_ct_list[[j]] <- topTable(tmp,  n=Inf, sort='none')
    names(result_ct_list)[[j]] <- grp_temp[j]
  }
  DE_ct_result[[i]] <- result_ct_list

  
}

```

```{r}
## perturbation model prediction
DE_pt_result <- list()
for (i in cell_type_name){
  pt_DE_temp <- pt_DE[ct_DE$cell_type==i,]
  Rpert_temp <- as.factor(Rpert[pt_DE$cell_type==i])
  donor_id <- pt_DE_temp$donor_id
  plate_name <- pt_DE_temp$plate_name
  row <- pt_DE_temp$row
  counts <- data.frame(t(pt_DE_temp[,-(1:6)]))
  counts[counts<0] <- 0
  d0 <- DGEList(counts)
  d0 <- calcNormFactors(d0)

  mm <- model.matrix(~0+Rpert_temp+donor_id+plate_name+row)
  y <- voom(d0, mm, plot=TRUE)
  fit <- lmFit(y, mm)
  
  grp_temp <- colnames(coef(fit))[colnames(coef(fit)) %like% "Rpert" & colnames(coef(fit)) != "Rpert_temp2"]
  result_pt_list <- list()
  for (j in 1:length(grp_temp)){
    contr <- makeContrasts(contrasts = paste0(grp_temp[j],"-","Rpert_temp2"), levels = colnames(coef(fit)))
    tmp <- contrasts.fit(fit, contr)
    tmp <- eBayes(tmp)
    result_pt_list[[j]] <- topTable(tmp,  n=Inf, sort='none')
  }
  DE_pt_result[[i]] <- result_pt_list
}

```

```{r}
## two-factor model prediction
DE_tf_result <- list()
for (i in cell_type_name){
  tf_DE_temp <- tf_DE[ct_DE$cell_type==i,]
  Rpert_temp <- as.factor(Rpert[tf_DE$cell_type==i])
  donor_id <- tf_DE_temp$donor_id
  plate_name <- tf_DE_temp$plate_name
  row <- tf_DE_temp$row
  counts <- data.frame(t(tf_DE_temp[,-(1:6)]))
  counts[counts<0] <- 0
  d0 <- DGEList(counts)
  d0 <- calcNormFactors(d0)

  mm <- model.matrix(~0+Rpert_temp+donor_id+plate_name+row)
  y <- voom(d0, mm, plot=TRUE)
  fit <- lmFit(y, mm)
  
  grp_temp <- colnames(coef(fit))[colnames(coef(fit)) %like% "Rpert" & colnames(coef(fit)) != "Rpert_temp2"]
  result_tf_list <- list()
  for (j in 1:length(grp_temp)){
    contr <- makeContrasts(contrasts = paste0(grp_temp[j],"-","Rpert_temp2"), levels = colnames(coef(fit)))
    tmp <- contrasts.fit(fit, contr)
    tmp <- eBayes(tmp)
    result_tf_list[[j]] <- topTable(tmp,  n=Inf, sort='none')
  }
  DE_tf_result[[i]] <- result_tf_list
}

```

```{r}
## sia model prediction
DE_sia_result <- list()
for (i in cell_type_name){
  sia_DE_temp <- sia_DE[ct_DE$cell_type==i,]
  Rpert_temp <- as.factor(Rpert[sia_DE$cell_type==i])
  donor_id <- sia_DE_temp$donor_id
  plate_name <- sia_DE_temp$plate_name
  row <- sia_DE_temp$row
  counts <- data.frame(t(sia_DE_temp[,-(1:6)]))
  counts[counts<0] <- 0
  d0 <- DGEList(counts)
  d0 <- calcNormFactors(d0, na.rm=TRUE)

  mm <- model.matrix(~0+Rpert_temp+donor_id+plate_name+row)
  y <- voom(d0, mm, plot=TRUE)
  fit <- lmFit(y, mm)
  
  grp_temp <- colnames(coef(fit))[colnames(coef(fit)) %like% "Rpert" & colnames(coef(fit)) != "Rpert_temp2"]
  result_sia_list <- list()
  for (j in 1:length(grp_temp)){
    contr <- makeContrasts(contrasts = paste0(grp_temp[j],"-","Rpert_temp2"), levels = colnames(coef(fit)))
    tmp <- contrasts.fit(fit, contr)
    tmp <- eBayes(tmp)
    result_sia_list[[j]] <- topTable(tmp,  n=Inf, sort='none')
  }
  DE_sia_result[[i]] <- result_sia_list
}

```

```{r,fig.height=10}
## Some volcano plots
for (i in 1: length(DE_sia_result[[5]])){
  df_temp <- data.frame(rownames(DE_sia_result[[5]][[i]]),DE_sia_result[[5]][[i]]$P.Value,DE_sia_result[[5]][[i]]$logFC)
  names(df_temp) <- c("gene_name","P.Val","logFC")
  v <- EnhancedVolcano(df_temp,
       lab = gene_name,
       title = " ",
       x = 'logFC',
       y = 'P.Val',
       pCutoff=0.05,
       FCcutoff = 1,
       ylim = c(0,max(-log10(df_temp$P.Val))+0.5))
  print(v)
}
```

```{r, fig.height=10}
for (i in 1: length(DE_pt_result[[1]])){
  df_temp <- data.frame(rownames(DE_pt_result[[1]][[i]]),DE_pt_result[[1]][[i]]$P.Value,DE_pt_result[[1]][[i]]$logFC)
  names(df_temp) <- c("gene_name","P.Val","logFC")
  v <- EnhancedVolcano(df_temp,
       lab = gene_name,
       title = " ",
       x = 'logFC',
       y = 'P.Val',
       pCutoff=0.05,
       FCcutoff = 1,
       ylim = c(0,max(-log10(df_temp$P.Val))+0.5))
  print(v)
}
```

## Compare results

### Compare average R2

```{r}
mthd <- c("cell type", "perturbation","two-factor","SIA")
r2 <- c(mean(r2_ct),mean(r2_pt),mean(r2_tf),mean(r2_sia,na.rm = TRUE))
r2 <- round(r2,2)
dt <- data.frame(mthd,r2)

p3 <- ggplot(dt, aes(y=r2, x=mthd)) + geom_bar(position = "dodge", stat="identity", fill="blue")+geom_text(aes(label = r2),position = position_dodge(width = 0.9), vjust=-0.3)+xlab("Model")+ylab(TeX("$R^2$")) +ylim(c(0,1))
p3

```

### In vitro DEG vs predicted DEG

```{r}
## Get cell type and perturbation names in DE results

cell_type_vec <- c()
Rpert_vec <- c()
for (i in 1:length(DE_ct_result)){
  cell_type_vec <- c(cell_type_vec,rep(names(DE_ct_result)[i],length(DE_ct_result[[i]])))
  Rpert_vec <- c(Rpert_vec,names(DE_ct_result[[i]]))
}

Rpert_index <- as.numeric(sub(".*temp","",Rpert_vec))

pert_comp <- data.frame(pert,Rpert_uni)
pert_vec <- c()
for (i in 1:length(Rpert_index)){
  pert_vec[i] <- pert[Rpert_uni==Rpert_index[i]]
}

test_cmb <- data.frame(cell_type_vec,pert_vec)
names(test_cmb) <- c("cell_type","sm_name")

## Get p value and lfc from DE_results
## For 4 methods
DE_ct_p <- data.frame()
for (i in 1: length(DE_ct_result)){
  temp <- DE_ct_result[[i]]
  for (j in 1:length(temp)){
    DE_ct_p <- data.frame(rbind(DE_ct_p,as.vector(temp[[j]]$P.Value)))
  }
}
names(DE_ct_p) <- gene_name

DE_ct_lfc <- data.frame()
for (i in 1: length(DE_ct_result)){
  temp <- DE_ct_result[[i]]
  for (j in 1:length(temp)){
    DE_ct_lfc <- data.frame(rbind(DE_ct_lfc,as.vector(temp[[j]]$logFC)))
  }
}
names(DE_ct_lfc) <- gene_name

#####

DE_pt_p <- data.frame()
for (i in 1: length(DE_pt_result)){
  temp <- DE_pt_result[[i]]
  for (j in 1:length(temp)){
    DE_pt_p <- data.frame(rbind(DE_pt_p,as.vector(temp[[j]]$P.Value)))
  }
}
names(DE_pt_p) <- gene_name

DE_pt_lfc <- data.frame()
for (i in 1: length(DE_pt_result)){
  temp <- DE_pt_result[[i]]
  for (j in 1:length(temp)){
    DE_pt_lfc <- data.frame(rbind(DE_pt_lfc,as.vector(temp[[j]]$logFC)))
  }
}
names(DE_pt_lfc) <- gene_name

#####

DE_tf_p <- data.frame()
for (i in 1: length(DE_tf_result)){
  temp <- DE_tf_result[[i]]
  for (j in 1:length(temp)){
    DE_tf_p <- data.frame(rbind(DE_tf_p,as.vector(temp[[j]]$P.Value)))
  }
}
names(DE_tf_p) <- gene_name

DE_tf_lfc <- data.frame()
for (i in 1: length(DE_tf_result)){
  temp <- DE_tf_result[[i]]
  for (j in 1:length(temp)){
    DE_tf_lfc <- data.frame(rbind(DE_tf_lfc,as.vector(temp[[j]]$logFC)))
  }
}
names(DE_tf_lfc) <- gene_name

#####

DE_sia_p <- data.frame()
for (i in 1: length(DE_sia_result)){
  temp <- DE_sia_result[[i]]
  for (j in 1:length(temp)){
    DE_sia_p <- data.frame(rbind(DE_sia_p,as.vector(temp[[j]]$P.Value)))
  }
}
names(DE_sia_p) <- gene_name

DE_sia_lfc <- data.frame()
for (i in 1: length(DE_sia_result)){
  temp <- DE_sia_result[[i]]
  for (j in 1:length(temp)){
    DE_sia_lfc <- data.frame(rbind(DE_sia_lfc,as.vector(temp[[j]]$logFC)))
  }
}
names(DE_sia_lfc) <- gene_name
```

#### In Vitro DEG's

```{r}
test_cmb_ix <- test_cmb[test_cmb$sm_name!="Dabrafenib" & test_cmb$sm_name!="Belinostat",]
```

```{r}
DEG_iv <- list()
for (i in 1:nrow(test_cmb_ix)){
  ix <- DE_p_value_df$cell_type==test_cmb_ix$cell_type[i] & DE_p_value_df$sm_name==test_cmb_ix$sm_name[i]
  temp1 <- DE_p_value_df[ix,-c(1,2)]
  temp2 <- DE_lfc_df[ix,-c(1,2)]
  DEG_iv[[i]] <- gene_name[temp1<0.05 & abs(temp2)>1]
}
```

#### Predicted DEG's

```{r}
DE_ct_p_ix <- DE_ct_p[test_cmb$sm_name!="Dabrafenib" & test_cmb$sm_name!="Belinostat",]
DE_ct_lfc_ix <- DE_ct_lfc[test_cmb$sm_name!="Dabrafenib" & test_cmb$sm_name!="Belinostat",]
DE_pt_p_ix <- DE_pt_p[test_cmb$sm_name!="Dabrafenib" & test_cmb$sm_name!="Belinostat",]
DE_pt_lfc_ix <- DE_pt_lfc[test_cmb$sm_name!="Dabrafenib" & test_cmb$sm_name!="Belinostat",]
DE_tf_p_ix <- DE_tf_p[test_cmb$sm_name!="Dabrafenib" & test_cmb$sm_name!="Belinostat",]
DE_tf_lfc_ix <- DE_tf_lfc[test_cmb$sm_name!="Dabrafenib" & test_cmb$sm_name!="Belinostat",]
DE_sia_p_ix <- DE_sia_p[test_cmb$sm_name!="Dabrafenib" & test_cmb$sm_name!="Belinostat",]
DE_sia_lfc_ix <- DE_sia_lfc[test_cmb$sm_name!="Dabrafenib" & test_cmb$sm_name!="Belinostat",]
```

```{r}
DEG_ct <- list()
for (i in 1:nrow(test_cmb_ix)){
  temp1 <- DE_ct_p_ix[i,]
  temp2 <- DE_ct_lfc_ix[i,]
  DEG_ct[[i]] <- gene_name[temp1<0.05 & abs(temp2)>1]
}

DEG_pt <- list()
for (i in 1:nrow(test_cmb_ix)){
  temp1 <- DE_pt_p_ix[i,]
  temp2 <- DE_pt_lfc_ix[i,]
  DEG_pt[[i]] <- gene_name[temp1<0.05 & abs(temp2)>1]
}

DEG_tf <- list()
for (i in 1:nrow(test_cmb_ix)){
  temp1 <- DE_tf_p_ix[i,]
  temp2 <- DE_tf_lfc_ix[i,]
  DEG_tf[[i]] <- gene_name[temp1<0.05 & abs(temp2)>1]
}

DEG_sia <- list()
for (i in 1:nrow(test_cmb_ix)){
  temp1 <- DE_sia_p_ix[i,]
  temp2 <- DE_sia_lfc_ix[i,]
  DEG_sia[[i]] <- gene_name[temp1<0.05 & abs(temp2)>1]
}
```

#### Predicted scores

```{r}
score_ct <- list()
for (i in 1: nrow(test_cmb_ix)){
  temp1 <- DE_ct_p_ix[i,]
  temp1 <- ifelse(temp1>=0.05,0,1)
  temp2 <- DE_ct_lfc_ix[i,]
  score_ct[[i]] <- temp1*abs(temp2)
}

score_pt <- list()
for (i in 1: nrow(test_cmb_ix)){
  temp1 <- DE_pt_p_ix[i,]
  temp1 <- ifelse(temp1>=0.05,0,1)
  temp2 <- DE_pt_lfc_ix[i,]
  score_pt[[i]] <- temp1*abs(temp2)
}

score_tf <- list()
for (i in 1: nrow(test_cmb_ix)){
  temp1 <- DE_tf_p_ix[i,]
  temp1 <- ifelse(temp1>=0.05,0,1)
  temp2 <- DE_tf_lfc_ix[i,]
  score_tf[[i]] <- temp1*abs(temp2)
}

score_sia <- list()
for (i in 1: nrow(test_cmb_ix)){
  temp1 <- DE_sia_p_ix[i,]
  temp1 <- ifelse(temp1>=0.05,0,1)
  temp2 <- DE_sia_lfc_ix[i,]
  score_sia[[i]] <- temp1*abs(temp2)
}
```

#### Calculate PR-AUC and generate PR curves

```{r}
library(ggplot2)
library(yardstick)
library(dplyr)
pr_auc_ct <- c()
pr_auc_pt <- c()
pr_auc_tf <- c()
pr_auc_sia <- c()
pr_curve <- list()
for (i in 1: nrow(test_cmb_ix)){
  true <- rep(0,length(gene_name))
  true[which(gene_name %in% DEG_iv[[i]])] <- 1
  dt <- data.frame(as.factor(true),t(score_ct[[i]]))
  names(dt) <- c("true","score")
  dt2 <- data.frame(as.factor(true),t(score_pt[[i]]))
  names(dt2) <- c("true","score")
  dt3 <- data.frame(as.factor(true),t(score_tf[[i]]))
  names(dt3) <- c("true","score")
  dt4 <- data.frame(as.factor(true),t(score_sia[[i]]))
  names(dt4) <- c("true","score")
  dtf <- rbind(dt,dt2,dt3,dt4)
  method <- c(rep("cell_type",nrow(dt)),rep("perturbation",nrow(dt2)),rep("two-factor",nrow(dt3)),rep("sia",nrow(dt4)))
  dtf <- data.frame(dtf,method)
  pr_auc_ct[i] <- as.numeric(pr_auc(dt, true, score, event_level = "second")[3])
  pr_auc_pt[i] <- as.numeric(pr_auc(dt2, true, score, event_level = "second")[3])
  pr_auc_tf[i] <- as.numeric(pr_auc(dt3, true, score, event_level = "second")[3])
  pr_auc_sia[i] <- as.numeric(pr_auc(dt4, true, score, event_level = "second")[3])
  pr_curve[[i]] <- dtf %>%
         group_by(method) %>%
         pr_curve(true, score, event_level = "second") %>%
         ggplot(aes(x = recall, y = precision, color=method)) +
         geom_path() +
         coord_equal() +
         theme_bw()+
         ggtitle(paste0(test_cmb_ix$cell_type[i],"_",test_cmb_ix$sm_name[i]))
         print(pr_curve[[i]])
}
```

