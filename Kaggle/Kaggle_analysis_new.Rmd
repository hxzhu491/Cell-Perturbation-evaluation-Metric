---
title: "Kaggle_bulked_eda"
author: "Hongxu Zhu"
always_allow_html: yes
date: "`r Sys.Date()`"
output:
  html_document:
    theme: united
    toc: yes
    toc_collapsed: yes
    toc_float: yes
---

```{r alternative-preambles,echo=FALSE,include=FALSE,eval=FALSE}
## if using word replace output with
output:
  word_document:
    toc: yes

## if using pdf replace output with
output:
  pdf_document:
    toc: yes
header-includes:
  - \usepackage{xcolor}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

## colorizes text when using html or pdf output
## just spits out text x for word
colorize <- function(x, color) {
  if(color=="todo"){
    color <- "red"
    x <- paste0("TODO: ",x)
  }
  if (knitr::is_latex_output()) {
    sprintf("\\textcolor{%s}{%s}", color, x)
  } else if (knitr::is_html_output()) {
    sprintf("<span style='color: %s;'>%s</span>", color, 
      x)
  } else x
}

todo <- function(x){
  paste0("**",colorize(x,"todo"),"**")
}

library(kableExtra)
library(cmapR)
library(edgeR)
library(arrow)
```

## Input bulked data

```{r}
bulk_adata_obs <- read.csv("datasets/bulk_adata_obs.csv")
bulk_adata_var <- read.csv("datasets/bulk_adata_var.csv")
bulk_adata_X <- read.csv("datasets/bulk_adata_X.csv", header = TRUE)
bulk_adata_X <- bulk_adata_X[,-1]
gene_name <- rownames(bulk_adata_var)
```


## Input reference file

```{r}
de_train <- read_parquet("datasets/de_train.parquet")
```

## Input Computed DEG results, Compute score and compare to reference file

```{r}
library(gtools)
library(ggplot2)
c_type <- c("B cells", "Myeloid cells","NK cells","T cells CD4_","T cells CD8+","T regulatory cells")
paths <- c("pseudo-bulking/pseudo-bulking/cell_type_B","pseudo-bulking/pseudo-bulking/cell_type_Myeloid", "pseudo-bulking/pseudo-bulking/cell_type_NK","pseudo-bulking/pseudo-bulking/cell_type_T4","pseudo-bulking/pseudo-bulking/cell_type_T8","pseudo-bulking/pseudo-bulking/cell_type_Treg")
pattern <- "*.csv"

## Create data frame with p-value

DE_p_value_list <- list()
for (i in 1: length(paths)){
  path <- paths[i]
  file_list <- mixedsort(list.files(path, pattern, full.names = TRUE))
  temp <- lapply(file_list, read.csv)
  DE_p_value <- data.frame()
  for (j in 1: length(temp)){
    DE_p_value <- rbind(DE_p_value,t(temp[[j]]$P.Value))
  }
  DE_p_value_list[[i]] <- DE_p_value
}

DE_p_value_df <- data.frame()
for (i in 1: length(DE_p_value_list)){
  DE_p_value_df <- rbind(DE_p_value_df,DE_p_value_list[[i]])
}

names(DE_p_value_df) <- gene_name

## Create data frame with log fold change

DE_lfc_list <- list()
for (i in 1: length(paths)){
  path <- paths[i]
  file_list <- mixedsort(list.files(path, pattern, full.names = TRUE))
  temp <- lapply(file_list, read.csv)
  DE_lfc <- data.frame()
  for (j in 1: length(temp)){
    DE_lfc <- rbind(DE_lfc,t(temp[[j]]$logFC))
  }
  DE_lfc_list[[i]] <- DE_lfc
}

DE_lfc_df <- data.frame()
for (i in 1: length(DE_lfc_list)){
  DE_lfc_df <- rbind(DE_lfc_df,DE_lfc_list[[i]])
}

names(DE_lfc_df) <- gene_name

## meta data for the created data frames

meta_path <- "pseudo-bulking/pseudo-bulking/input_obs"
meta_file_list <- list.files(meta_path,pattern,full.names = TRUE)
input_obs <- lapply(meta_file_list, read.csv)


# Note that, for DE result files, pert are labeled as "Rpert[number]" which could be found in the input_obs

Rpert_B <- c(0:4,6:17)
Rpert_Myeloid <- c(0:4,6:17)
Rpert_NK <- c(0:26,28:146)
Rpert_T4 <- c(0:24,26:146)
Rpert_T8 <- c(0:21,23:142)
Rpert_Treg <- c(0:26,28:146)

sm_name_B <- c()
for (i in 1:length(Rpert_B)){
  sm_name_B[i] <- unique(input_obs[[1]]$sm_name[input_obs[[1]]$Rpert==Rpert_B[i]])
}

sm_name_Myeloid <- c()
for (i in 1:length(Rpert_Myeloid)){
  sm_name_Myeloid[i] <- unique(input_obs[[2]]$sm_name[input_obs[[2]]$Rpert==Rpert_Myeloid[i]])
}

sm_name_NK <- c()
for (i in 1:length(Rpert_NK)){
  sm_name_NK[i] <- unique(input_obs[[3]]$sm_name[input_obs[[3]]$Rpert==Rpert_NK[i]])
}

sm_name_T4 <- c()
for (i in 1:length(Rpert_T4)){
  sm_name_T4[i] <- unique(input_obs[[4]]$sm_name[input_obs[[4]]$Rpert==Rpert_T4[i]])
}

sm_name_T8 <- c()
for (i in 1:length(Rpert_T8)){
  sm_name_T8[i] <- unique(input_obs[[5]]$sm_name[input_obs[[5]]$Rpert==Rpert_T8[i]])
}

sm_name_Treg <- c()
for (i in 1:length(Rpert_Treg)){
  sm_name_Treg[i] <- unique(input_obs[[6]]$sm_name[input_obs[[6]]$Rpert==Rpert_Treg[i]])
}

### Now we can create pert name for our p-value, logfc data frames

sm_name <- c(sm_name_B,sm_name_Myeloid,sm_name_NK,sm_name_T4,sm_name_T8,sm_name_Treg)

cell_type_name <- unique(de_train$cell_type)

cell_type <- c(rep("B cells",length(sm_name_B)),rep("Myeloid cells",length(sm_name_Myeloid)),rep("NK cells",length(sm_name_NK)),rep("T cells CD4+",length(sm_name_T4)),rep("T cells CD8+",length(sm_name_T8)),rep("T regulatory cells",length(sm_name_Treg)))

## Now add cell type and sm name to DE data frames

DE_p_value_df <- data.frame(cell_type,sm_name,DE_p_value_df)
DE_lfc_df <- data.frame(cell_type,sm_name,DE_lfc_df)

## compute score

score_df <- -log10(DE_p_value_df[,-(1:2)])*sign(DE_lfc_df[,-(1:2)])
score_df <- data.frame(cell_type,sm_name,score_df)

## Compare computed score with de_train(ground truth)

## Check all scatter plots
ct <- "T cells CD4+"
sn <- sm_name_T4[56:77]

for (i in 1: length(sn)){
  c1 <- score_df[score_df$cell_type==ct & score_df$sm_name==sn[i],-c(1,2)]
  c2 <- de_train[de_train$cell_type==ct & de_train$sm_name==sn[i],-(1:5)]
  computed <- t(data.frame(c1))
  truth <- t(data.frame(c2))
  df <- data.frame(computed,truth)
  names(df) <- c("computed","truth")
  p <- ggplot(df,aes(x=truth,y=computed))+geom_point(color="blue")
  print(p)
}

## We get the same results as the reference file
```
```{r, fig.height=10}
## Show some volcano plots
## B cells

B_pval <- DE_p_value[DE_p_value_df$cell_type=="B cells",]
names(B_pval) <- gene_name
B_lfc <- DE_lfc[DE_lfc_df$cell_type=="B cells",]
names(B_lfc) <- gene_name

library(EnhancedVolcano)

for (i in 1: nrow(B_pval)){
  df_temp <- data.frame(gene_name,t(B_pval[i,]),t(B_lfc[i,]))
  names(df_temp) <- c("gene_name","P.Val","logFC")
  v <- EnhancedVolcano(df_temp,
       lab = gene_name,
       title = paste0("B cells","__",sm_name_B[i]),
       x = 'logFC',
       y = 'P.Val',
       pCutoff=0.05,
       FCcutoff = 1,
       ylim = c(0,max(-log10(df_temp$P.Val))+0.5))
  print(v)
}
```

```{r,fig.height=10}
## NK cells
NK_pval <- DE_p_value[DE_p_value_df$cell_type=="NK cells",]
names(NK_pval) <- gene_name
NK_lfc <- DE_lfc[DE_lfc_df$cell_type=="NK cells",]
names(NK_lfc) <- gene_name

library(EnhancedVolcano)

for (i in 15: 36){
  df_temp <- data.frame(gene_name,t(NK_pval[i,]),t(NK_lfc[i,]))
  names(df_temp) <- c("gene_name","P.Val","logFC")
  v <- EnhancedVolcano(df_temp,
       lab = gene_name,
       title = paste0("NK cells","__",sm_name_NK[i]),
       x = 'logFC',
       y = 'P.Val',
       pCutoff=0.05,
       FCcutoff = 1,
       ylim = c(0,max(-log10(df_temp$P.Val))+0.5))
  print(v)
}
```

## Work with pseudo-bulked data

```{r}
## take necessary variables in meta data
bulk_meta <- data.frame(bulk_adata_obs$cell_type,bulk_adata_obs$plate_name,bulk_adata_obs$row,bulk_adata_obs$donor_id,bulk_adata_obs$sm_lincs_id, bulk_adata_obs$sm_name)

names(bulk_meta) <- c("cell_type","plate_name","row","donor_id","sm_lincs_id","sm_name")
bulk_meta$sm_name[bulk_meta$sm_name=="Dimethyl Sulfoxide"] <- "DMSO"

## merge meta data and expression data
names(bulk_adata_X) <- gene_name
bulk_full <- data.frame(bulk_meta,bulk_adata_X)

```

```{r}
ii=1
a <- bulk_meta$cell_type==cmb_df$cell_type[ii] & bulk_meta$sm_name==cmb_df$sm_name[ii]
bulk_meta[a,]
```

### Overview of full data

```{r}
library(ComplexHeatmap)
tab <- table(bulk_meta$cell_type,bulk_meta$sm_lincs_id)
tab <- 1*(tab>0)
tab <- tab[,order(colSums(tab),decreasing=TRUE)]
tab <- tab[order(rowSums(tab),decreasing=FALSE),]
temp <- matrix(tab,nrow=nrow(tab))
dimnames(temp) <- dimnames(tab)
fsize <- 10

pdf("heatmap.pdf",width=20,height=10)
Heatmap(temp,col=c("white","blue"),cluster_rows=FALSE,cluster_columns=FALSE,row_title="Cell   type",column_title="Perturbation",show_row_names=TRUE,row_names_gp = gpar(fontsize=10),column_names_gp = gpar(fontsize=8), show_heatmap_legend=FALSE, rect_gp = gpar(col="grey"))
dev.off()
```

## Fit benchmark models

```{r}
source("./models/cell_model.R")
```

```{r}
## Create all possible combinations in the dataset
cmb <- data.frame(bulk_meta$cell_type,bulk_meta$sm_name)
cmb_vec <- paste0(bulk_meta$cell_type,"#",bulk_meta$sm_name)
cmb_uni <- unique(cmb_vec)
cmb_list <- strsplit(cmb_uni, split = "#")

cmb_cell <- c()
cmb_pert <- c()
for (i in 1:length(cmb_list)){
  cmb_cell[i] <- cmb_list[[i]][1]
  cmb_pert[i] <- cmb_list[[i]][2]
}

cmb_df <- data.frame(cmb_cell,cmb_pert)
names(cmb_df) <- c("cell_type", "sm_name")

## Don't use DMSO as testing set

cmb_df <- cmb_df[-which(cmb_df$sm_name=="DMSO"),]
```

### Get cell tpye model prediction

```{r}
fit <- lm(as.matrix(bulk_adata_X) ~ bulk_meta$cell_type, x=TRUE)

ct_pred <- list()
for (i in 1: nrow(cmb_df)){
  ix <- cmb_df$cell_type==cmb_df$cell_type[i] & cmb_df$sm_name==cmb_df$sm_name[i]
  obs_test <- fit$x[ix,]
  obs_train <- fit$x[!ix,]

  X_test <-as.matrix(bulk_adata_X[ix,]) 
  X_train <- as.matrix(bulk_adata_X[!ix,])

  fit.x <- lm.fit(obs_train,X_train)
  pred_ct <- obs_test%*%fit.x$coefficients
  names(pred_ct) <- gene_name
  ct_pred[[i]] <- pred_ct[1,]
}

ct_pred_df <- data.frame()
for (i in 1:length(ct_pred)){
  ct_pred_df <- data.frame(rbind(ct_pred_df,as.vector(ct_pred[[i]])))
} 
names(ct_pred_df) <- gene_name

write.csv(ct_pred_df, "./Rmd_output/cell_model_pred.csv")
```

### Get perturbation model prediction

```{r}
fit <- lm(as.matrix(bulk_adata_X) ~ bulk_meta$sm_name, x=TRUE)

pt_pred <- list()
for (i in 1: nrow(cmb_df)){
  ix <- cmb_df$cell_type==cmb_df$cell_type[i] & cmb_df$sm_name==cmb_df$sm_name[i]
  obs_test <- fit$x[ix,]
  obs_train <- fit$x[!ix,]

  X_test <-as.matrix(bulk_adata_X[ix,]) 
  X_train <- as.matrix(bulk_adata_X[!ix,])

  fit.x <- lm.fit(obs_train,X_train)
  pred_pt <- obs_test%*%fit.x$coefficients
  names(pred_pt) <- gene_name
  pt_pred[[i]] <- pred_pt[1,]
}

pt_pred_df <- data.frame()
for (i in 1:length(pt_pred)){
  pt_pred_df <- data.frame(rbind(pt_pred_df,as.vector(pt_pred[[i]])))
} 
names(pt_pred_df) <- gene_name

write.csv(pt_pred_df, "./Rmd_output/pert_model_pred.csv")
```

### Get two-factor model prediction

```{r}
fit <- lm(as.matrix(bulk_adata_X) ~ bulk_meta$sm_name + bulk_meta$cell_type, x=TRUE)

tf_pred <- list()
for (i in 1: nrow(cmb_df)){
  ix <- cmb_df$cell_type==cmb_df$cell_type[i] & cmb_df$sm_name==cmb_df$sm_name[i]
  obs_test <- fit$x[ix,]
  obs_train <- fit$x[!ix,]

  X_test <-as.matrix(bulk_adata_X[ix,]) 
  X_train <- as.matrix(bulk_adata_X[!ix,])

  fit.x <- lm.fit(obs_train,X_train)
  pred_tf <- obs_test%*%fit.x$coefficients
  names(pred_tf) <- gene_name
  tf_pred[[i]] <- pred_pt[1,]
}

tf_pred_df <- data.frame()
for (i in 1:length(tf_pred)){
  tf_pred_df <- data.frame(rbind(tf_pred_df,as.vector(tf_pred[[i]])))
} 
names(tf_pred_df) <- gene_name


write.csv(tf_pred_df, "./Rmd_output/tf_model_pred.csv")

```

## Fit in silico models

For this pseudo-bulked data set, our plan is to fit in silico models on each cluster. We then use the prediction from in silico models on each cluster to perform the in silico DEG following the same in vitro DEG pipeline.

```{r}
## check number of samples for each combination
check <- c()
for (ii in 1: nrow(cmb_df)){
  a <- bulk_meta$cell_type==cmb_df$cell_type[ii] & bulk_meta$sm_name==cmb_df$sm_name[ii]
  check[ii] <- nrow(bulk_meta[a,])
}

check

## We may remove combinations that less than 3 samples

```

```{r}
c("Dabrafenib","Belinostat")
```

```{r}
## get filtered dataset

rm_index_list <- list()
c <- 0
for (ii in 1: nrow(cmb_df)){
  a <- bulk_meta$cell_type==cmb_df$cell_type[ii] & bulk_meta$sm_name==cmb_df$sm_name[ii]
  if (nrow(bulk_meta[a,])<3){
    c <- c+1
    rm_index_list[[c]] <- as.numeric(rownames(bulk_meta[a,]))
  }
}

rm_index <- c()
for (ii in 1:length(rm_index_list)){
  rm_index <- c(rm_index,rm_index_list[[ii]])
}

bulk_meta_rm <- bulk_meta[-rm_index,]
bulk_adata_X_rm <- bulk_adata_X[-rm_index,]

bulk_meta_d0 <- bulk_meta_rm[bulk_meta_rm$donor_id=="donor_0",]
bulk_meta_d1 <- bulk_meta_rm[bulk_meta_rm$donor_id=="donor_1",]
bulk_meta_d2 <- bulk_meta_rm[bulk_meta_rm$donor_id=="donor_2",]

bulk_X_d0 <- bulk_adata_X_rm[bulk_meta_rm$donor_id=="donor_0",]
bulk_X_d1 <- bulk_adata_X_rm[bulk_meta_rm$donor_id=="donor_1",]
bulk_X_d2 <- bulk_adata_X_rm[bulk_meta_rm$donor_id=="donor_2",]
```

```{r}
## check combinations in each donor
## Exclude all controls: "DMSO", "Dabrafenib" and "Belinostat" in test set.

### d0
cmb_d0 <- data.frame(bulk_meta_d0$cell_type,bulk_meta_d0$sm_name)
cmb_d0_vec <- paste0(bulk_meta_d0$cell_type,"#",bulk_meta_d0$sm_name)
cmb_d0_uni <- unique(cmb_d0_vec)
cmb_d0_list <- strsplit(cmb_d0_uni, split = "#")

cmb_d0_cell <- c()
cmb_d0_pert <- c()
for (i in 1:length(cmb_d0_list)){
  cmb_d0_cell[i] <- cmb_d0_list[[i]][1]
  cmb_d0_pert[i] <- cmb_d0_list[[i]][2]
}

cmb_d0_df <- data.frame(cmb_d0_cell,cmb_d0_pert)
names(cmb_d0_df) <- c("cell_type", "sm_name")
cmb_d0_df <- cmb_d0_df[-which(cmb_d0_df$sm_name=="DMSO" | cmb_d0_df$sm_name=="Dabrafenib" | cmb_d0_df$sm_name=="Belinostat"),]

### d1
cmb_d1 <- data.frame(bulk_meta_d1$cell_type,bulk_meta_d1$sm_name)
cmb_d1_vec <- paste0(bulk_meta_d1$cell_type,"#",bulk_meta_d1$sm_name)
cmb_d1_uni <- unique(cmb_d1_vec)
cmb_d1_list <- strsplit(cmb_d1_uni, split = "#")

cmb_d1_cell <- c()
cmb_d1_pert <- c()
for (i in 1:length(cmb_d1_list)){
  cmb_d1_cell[i] <- cmb_d1_list[[i]][1]
  cmb_d1_pert[i] <- cmb_d1_list[[i]][2]
}

cmb_d1_df <- data.frame(cmb_d1_cell,cmb_d1_pert)
names(cmb_d1_df) <- c("cell_type", "sm_name")
cmb_d1_df <- cmb_d0_df[-which(cmb_d1_df$sm_name=="DMSO" | cmb_d1_df$sm_name=="Dabrafenib" | cmb_d1_df$sm_name=="Belinostat"),]


### d2
cmb_d2 <- data.frame(bulk_meta_d2$cell_type,bulk_meta_d2$sm_name)
cmb_d2_vec <- paste0(bulk_meta_d2$cell_type,"#",bulk_meta_d2$sm_name)
cmb_d2_uni <- unique(cmb_d2_vec)
cmb_d2_list <- strsplit(cmb_d2_uni, split = "#")

cmb_d2_cell <- c()
cmb_d2_pert <- c()
for (i in 1:length(cmb_d2_list)){
  cmb_d2_cell[i] <- cmb_d2_list[[i]][1]
  cmb_d2_pert[i] <- cmb_d2_list[[i]][2]
}

cmb_d2_df <- data.frame(cmb_d2_cell,cmb_d2_pert)
names(cmb_d2_df) <- c("cell_type", "sm_name")
cmb_d2_df <- cmb_d2_df[-which(cmb_d2_df$sm_name=="DMSO" | cmb_d2_df$sm_name=="Dabrafenib" | cmb_d2_df$sm_name=="Belinostat"),]

```

## Fit in silico models on pseudo-bulked level

### Cell type model

```{r}
## for d0

fit <- lm(as.matrix(bulk_X_d0) ~ bulk_meta_d0$cell_type, x=TRUE)

ct_pred_d0 <- list()
for (i in 1: nrow(cmb_d0_df)){
  ix <- bulk_meta_d0$cell_type==cmb_d0_df$cell_type[i] & bulk_meta_d0$sm_name==cmb_d0_df$sm_name[i]
  obs_test <- fit$x[ix,]
  obs_train <- fit$x[!ix,]

  X_test <- as.matrix(bulk_X_d0[ix,]) 
  X_train <- as.matrix(bulk_X_d0[!ix,])

  fit.x <- lm.fit(obs_train,X_train)
  pred_ct_d0 <- obs_test%*%fit.x$coefficients
  names(pred_ct_d0) <- gene_name
  ct_pred_d0[[i]] <- pred_ct_d0[1,]
}

ct_pred_d0_df <- data.frame()
for (i in 1:length(ct_pred_d0)){
  ct_pred_d0_df <- data.frame(rbind(ct_pred_d0_df,as.vector(ct_pred_d0[[i]])))
} 
names(ct_pred_d0_df) <- gene_name

pred_meta_d0 <- data.frame()
for (i in 1: nrow(cmb_d0_df)){
  ix <- bulk_meta_d0$cell_type==cmb_d0_df$cell_type[i] & bulk_meta_d0$sm_name==cmb_d0_df$sm_name[i]
  meta_test <- bulk_meta_d0[ix,]
  pred_meta_d0 <- data.frame(rbind(pred_meta_d0,meta_test))
}

## for d1

fit <- lm(as.matrix(bulk_X_d1) ~ bulk_meta_d1$cell_type, x=TRUE)

ct_pred_d1 <- list()
for (i in 1: nrow(cmb_d1_df)){
  ix <- bulk_meta_d1$cell_type==cmb_d1_df$cell_type[i] & bulk_meta_d1$sm_name==cmb_d1_df$sm_name[i]
  obs_test <- fit$x[ix,]
  obs_train <- fit$x[!ix,]

  X_test <- as.matrix(bulk_X_d1[ix,]) 
  X_train <- as.matrix(bulk_X_d1[!ix,])

  fit.x <- lm.fit(obs_train,X_train)
  pred_ct_d1 <- obs_test%*%fit.x$coefficients
  names(pred_ct_d1) <- gene_name
  ct_pred_d1[[i]] <- pred_ct_d1[1,]
}

ct_pred_d1_df <- data.frame()
for (i in 1:length(ct_pred_d1)){
  ct_pred_d1_df <- data.frame(rbind(ct_pred_d1_df,as.vector(ct_pred_d1[[i]])))
} 
names(ct_pred_d1_df) <- gene_name

pred_meta_d1 <- data.frame()
for (i in 1: nrow(cmb_d1_df)){
  ix <- bulk_meta_d1$cell_type==cmb_d1_df$cell_type[i] & bulk_meta_d1$sm_name==cmb_d1_df$sm_name[i]
  meta_test <- bulk_meta_d1[ix,]
  pred_meta_d1 <- data.frame(rbind(pred_meta_d1,meta_test))
}

## for d2

fit <- lm(as.matrix(bulk_X_d2) ~ bulk_meta_d2$cell_type, x=TRUE)

ct_pred_d2 <- list()
for (i in 1: nrow(cmb_d2_df)){
  ix <- bulk_meta_d2$cell_type==cmb_d2_df$cell_type[i] & bulk_meta_d2$sm_name==cmb_d2_df$sm_name[i]
  obs_test <- fit$x[ix,]
  obs_train <- fit$x[!ix,]

  X_test <- as.matrix(bulk_X_d2[ix,]) 
  X_train <- as.matrix(bulk_X_d2[!ix,])

  fit.x <- lm.fit(obs_train,X_train)
  pred_ct_d2 <- obs_test%*%fit.x$coefficients
  names(pred_ct_d2) <- gene_name
  ct_pred_d2[[i]] <- pred_ct_d2[1,]
}

ct_pred_d2_df <- data.frame()
for (i in 1:length(ct_pred_d2)){
  ct_pred_d2_df <- data.frame(rbind(ct_pred_d2_df,as.vector(ct_pred_d2[[i]])))
} 
names(ct_pred_d2_df) <- gene_name

pred_meta_d2 <- data.frame()
for (i in 1: nrow(cmb_d2_df)){
  ix <- bulk_meta_d2$cell_type==cmb_d2_df$cell_type[i] & bulk_meta_d2$sm_name==cmb_d2_df$sm_name[i]
  meta_test <- bulk_meta_d2[ix,]
  pred_meta_d2 <- data.frame(rbind(pred_meta_d2,meta_test))
}

## full prediction result for cell model
ct_pred_full_d0 <- data.frame(pred_meta_d0,ct_pred_d0_df)
ct_pred_full_d1 <- data.frame(pred_meta_d1,ct_pred_d1_df)
ct_pred_full_d2 <- data.frame(pred_meta_d2,ct_pred_d2_df)

ct_pred_full <- data.frame(rbind(ct_pred_full_d0,ct_pred_full_d1,ct_pred_full_d2))

```

```{r}
ct_pred_d0_df_temp <- ct_pred_d0_df[1:100,]
ct_pred_d1_df_temp <- ct_pred_d1_df[1:100,]
ct_pred_d2_df_temp <- ct_pred_d2_df[1:100,]

ct_pred_full_d0_temp <- data.frame(pred_meta_d0[1:100,],ct_pred_d0_df_temp)
ct_pred_full_d1_temp <- data.frame(pred_meta_d1[1:100,],ct_pred_d1_df_temp)
ct_pred_full_d2_temp <- data.frame(pred_meta_d2[1:100,],ct_pred_d2_df_temp)

ct_pred_full_temp <- data.frame(rbind(ct_pred_full_d0_temp,ct_pred_full_d1_temp,ct_pred_full_d2_temp))
```

### Perturbation model

```{r}
## for d0

fit <- lm(as.matrix(bulk_X_d0) ~ bulk_meta_d0$sm_name, x=TRUE)

pt_pred_d0 <- list()
for (i in 1: nrow(cmb_d0_df)){
  ix <- bulk_meta_d0$cell_type==cmb_d0_df$cell_type[i] & bulk_meta_d0$sm_name==cmb_d0_df$sm_name[i]
  obs_test <- fit$x[ix,]
  obs_train <- fit$x[!ix,]

  X_test <- as.matrix(bulk_X_d0[ix,]) 
  X_train <- as.matrix(bulk_X_d0[!ix,])

  fit.x <- lm.fit(obs_train,X_train)
  pred_pt_d0 <- obs_test%*%fit.x$coefficients
  names(pred_pt_d0) <- gene_name
  pt_pred_d0[[i]] <- pred_pt_d0[1,]
}

pt_pred_d0_df <- data.frame()
for (i in 1:length(pt_pred_d0)){
  pt_pred_d0_df <- data.frame(rbind(pt_pred_d0_df,as.vector(pt_pred_d0[[i]])))
} 
names(pt_pred_d0_df) <- gene_name

## for d1

fit <- lm(as.matrix(bulk_X_d1) ~ bulk_meta_d1$sm_name, x=TRUE)

pt_pred_d1 <- list()
for (i in 1: nrow(cmb_d1_df)){
  ix <- bulk_meta_d1$cell_type==cmb_d1_df$cell_type[i] & bulk_meta_d1$sm_name==cmb_d1_df$sm_name[i]
  obs_test <- fit$x[ix,]
  obs_train <- fit$x[!ix,]

  X_test <- as.matrix(bulk_X_d1[ix,]) 
  X_train <- as.matrix(bulk_X_d1[!ix,])

  fit.x <- lm.fit(obs_train,X_train)
  pred_pt_d1 <- obs_test%*%fit.x$coefficients
  names(pred_pt_d1) <- gene_name
  pt_pred_d1[[i]] <- pred_pt_d1[1,]
}

pt_pred_d1_df <- data.frame()
for (i in 1:length(pt_pred_d1)){
  pt_pred_d1_df <- data.frame(rbind(pt_pred_d1_df,as.vector(pt_pred_d1[[i]])))
} 
names(pt_pred_d1_df) <- gene_name

## for d2

fit <- lm(as.matrix(bulk_X_d2) ~ bulk_meta_d2$sm_name, x=TRUE)

pt_pred_d2 <- list()
for (i in 1: nrow(cmb_d2_df)){
  ix <- bulk_meta_d2$cell_type==cmb_d2_df$cell_type[i] & bulk_meta_d2$sm_name==cmb_d2_df$sm_name[i]
  obs_test <- fit$x[ix,]
  obs_train <- fit$x[!ix,]

  X_test <- as.matrix(bulk_X_d2[ix,]) 
  X_train <- as.matrix(bulk_X_d2[!ix,])

  fit.x <- lm.fit(obs_train,X_train)
  pred_pt_d2 <- obs_test%*%fit.x$coefficients
  names(pred_pt_d2) <- gene_name
  pt_pred_d2[[i]] <- pred_pt_d2[1,]
}

pt_pred_d2_df <- data.frame()
for (i in 1:length(pt_pred_d2)){
  pt_pred_d2_df <- data.frame(rbind(pt_pred_d2_df,as.vector(pt_pred_d2[[i]])))
} 
names(pt_pred_d2_df) <- gene_name

## full prediction result for pert model
pt_pred_full_d0 <- data.frame(pred_meta_d0,pt_pred_d0_df)
pt_pred_full_d1 <- data.frame(pred_meta_d1,pt_pred_d1_df)
pt_pred_full_d2 <- data.frame(pred_meta_d2,pt_pred_d2_df)

pt_pred_full <- data.frame(rbind(pt_pred_full_d0,pt_pred_full_d1,pt_pred_full_d2))
```

```{r}
## Temporarily use first 100 test set
pt_pred_full_temp <- read.csv("./Rmd_output/pert_model_pred.csv")
```

### Two factor model

```{r}
## for d0

fit <- lm(as.matrix(bulk_X_d0) ~ bulk_meta_d0$sm_name + bulk_meta_d0$cell_type, x=TRUE)

tf_pred_d0 <- list()
for (i in 1: nrow(cmb_d0_df)){
  ix <- bulk_meta_d0$cell_type==cmb_d0_df$cell_type[i] & bulk_meta_d0$sm_name==cmb_d0_df$sm_name[i]
  obs_test <- fit$x[ix,]
  obs_train <- fit$x[!ix,]

  X_test <- as.matrix(bulk_X_d0[ix,]) 
  X_train <- as.matrix(bulk_X_d0[!ix,])

  fit.x <- lm.fit(obs_train,X_train)
  pred_tf_d0 <- obs_test%*%fit.x$coefficients
  names(pred_tf_d0) <- gene_name
  tf_pred_d0[[i]] <- pred_tf_d0[1,]
}

tf_pred_d0_df <- data.frame()
for (i in 1:length(tf_pred_d0)){
  tf_pred_d0_df <- data.frame(rbind(tf_pred_d0_df,as.vector(tf_pred_d0[[i]])))
} 
names(tf_pred_d0_df) <- gene_name

## for d1

fit <- lm(as.matrix(bulk_X_d1) ~ bulk_meta_d1$sm_name + bulk_meta_d1$cell_type, x=TRUE)

tf_pred_d1 <- list()
for (i in 1: nrow(cmb_d1_df)){
  ix <- bulk_meta_d1$cell_type==cmb_d1_df$cell_type[i] & bulk_meta_d1$sm_name==cmb_d1_df$sm_name[i]
  obs_test <- fit$x[ix,]
  obs_train <- fit$x[!ix,]

  X_test <- as.matrix(bulk_X_d1[ix,]) 
  X_train <- as.matrix(bulk_X_d1[!ix,])

  fit.x <- lm.fit(obs_train,X_train)
  pred_tf_d1 <- obs_test%*%fit.x$coefficients
  names(pred_tf_d1) <- gene_name
  tf_pred_d1[[i]] <- pred_tf_d1[1,]
}

tf_pred_d1_df <- data.frame()
for (i in 1:length(tf_pred_d1)){
  tf_pred_d1_df <- data.frame(rbind(tf_pred_d1_df,as.vector(tf_pred_d1[[i]])))
} 
names(tf_pred_d1_df) <- gene_name

## for d2

fit <- lm(as.matrix(bulk_X_d2) ~ bulk_meta_d2$sm_name + bulk_meta_d2$cell_type, x=TRUE)

tf_pred_d2 <- list()
for (i in 1: nrow(cmb_d2_df)){
  ix <- bulk_meta_d2$cell_type==cmb_d2_df$cell_type[i] & bulk_meta_d2$sm_name==cmb_d2_df$sm_name[i]
  obs_test <- fit$x[ix,]
  obs_train <- fit$x[!ix,]

  X_test <- as.matrix(bulk_X_d2[ix,]) 
  X_train <- as.matrix(bulk_X_d2[!ix,])

  fit.x <- lm.fit(obs_train,X_train)
  pred_tf_d2 <- obs_test%*%fit.x$coefficients
  names(pred_tf_d2) <- gene_name
  tf_pred_d2[[i]] <- pred_tf_d2[1,]
}

tf_pred_d2_df <- data.frame()
for (i in 1:length(tf_pred_d2)){
  tf_pred_d2_df <- data.frame(rbind(tf_pred_d2_df,as.vector(tf_pred_d2[[i]])))
} 
names(tf_pred_d2_df) <- gene_name

## full prediction result for pert model
tf_pred_full_d0 <- data.frame(pred_meta_d0,tf_pred_d0_df)
tf_pred_full_d1 <- data.frame(pred_meta_d1,tf_pred_d1_df)
tf_pred_full_d2 <- data.frame(pred_meta_d2,tf_pred_d2_df)

tf_pred_full <- data.frame(rbind(tf_pred_full_d0,tf_pred_full_d1,tf_pred_full_d2))
```

```{r}
## Temporarily use first 100 test set
tf_pred_full_temp <- read.csv("./Rmd_output/tf_model_pred.csv")
```

## Measure the model performance by R2

### Cell model prediction

```{r}
### cmb for creating R2
cmb_temp <- data.frame(ct_pred_full_temp$cell_type,ct_pred_full_temp$sm_name)
cmb_vec_temp <- paste0(ct_pred_full_temp$cell_type,"#",ct_pred_full_temp$sm_name)
cmb_uni_temp <- unique(cmb_vec_temp)
cmb_list_temp <- strsplit(cmb_uni_temp, split = "#")

cmb_cell_temp <- c()
cmb_pert_temp <- c()
for (i in 1:length(cmb_list_temp)){
  cmb_cell_temp[i] <- cmb_list_temp[[i]][1]
  cmb_pert_temp[i] <- cmb_list_temp[[i]][2]
}

cmb_df_temp <- data.frame(cmb_cell_temp,cmb_pert_temp)
names(cmb_df_temp) <- c("cell_type", "sm_name")

## R2 for first 100 test sets

for (i in 1:100){
  ix <- bulk_meta$cell_type==cmb_df_temp$cell_type[i] & bulk_meta$sm_name==cmb_df_temp$sm_name[i]
  obs_expr <- bulk_adata_X[ix,]
  obs_mean <- apply(obs_expr,2,mean)
  ix_n <- ct_pred_full_temp$cell_type==cmb_df_temp$cell_type[i] & ct_pred_full_temp$sm_name==cmb_df_temp$sm_name[i]
  pred_expr <- ct_pred_full_temp[ix_n,-(1:6)]
  pred_mean <- apply(pred_expr,2,mean)
  r2 <- round(cor(obs_mean,pred_mean)^2,2)
  
  dt <- data.frame(gene_name,obs_mean,pred_mean)
  names(dt) <- c("gene_name","in_vitro_mean","in_silico_prediction")
  
  p <- ggplot(dt, aes(x=in_vitro_mean, y=in_silico_prediction)) + 
  geom_point(shape=2,alpha=0.8, color="blue")+
  geom_smooth(method=lm, na.rm = TRUE,colour="black")+
  xlab("in_vitro_mean") + ylab("in_silico_prediction")+ ggtitle(paste0(cmb_df_temp$cell_type[i],"_",cmb_df_temp$sm_name[i]))+
  labs(tag = paste0("R2=",r2))+ theme(plot.tag.position = "topright")+
    xlim(0,2000) + ylim(0,2000)
  print(p)
}
```

### Perturbation model prediction

```{r}
### cmb for creating R2
cmb_temp <- data.frame(pt_pred_full_temp$cell_type,pt_pred_full_temp$sm_name)
cmb_vec_temp <- paste0(pt_pred_full_temp$cell_type,"#",pt_pred_full_temp$sm_name)
cmb_uni_temp <- unique(cmb_vec_temp)
cmb_list_temp <- strsplit(cmb_uni_temp, split = "#")

cmb_cell_temp <- c()
cmb_pert_temp <- c()
for (i in 1:length(cmb_list_temp)){
  cmb_cell_temp[i] <- cmb_list_temp[[i]][1]
  cmb_pert_temp[i] <- cmb_list_temp[[i]][2]
}

cmb_df_temp <- data.frame(cmb_cell_temp,cmb_pert_temp)
names(cmb_df_temp) <- c("cell_type", "sm_name")

## R2 for first 100 test sets

for (i in 1:100){
  ix <- bulk_meta$cell_type==cmb_df_temp$cell_type[i] & bulk_meta$sm_name==cmb_df_temp$sm_name[i]
  obs_expr <- bulk_adata_X[ix,]
  obs_mean <- apply(obs_expr,2,mean)
  ix_n <- pt_pred_full_temp$cell_type==cmb_df_temp$cell_type[i] & pt_pred_full_temp$sm_name==cmb_df_temp$sm_name[i]
  pred_expr <- pt_pred_full_temp[ix_n,-(1:6)]
  pred_mean <- apply(pred_expr,2,mean)
  r2 <- round(cor(obs_mean,pred_mean)^2,2)
  d 
  dt <- data.frame(gene_name,obs_mean,pred_mean)
  names(dt) <- c("gene_name","in_vitro_mean","in_silico_prediction")
  
  p <- ggplot(dt, aes(x=in_vitro_mean, y=in_silico_prediction)) + 
  geom_point(shape=2,alpha=0.8, color="blue")+
  geom_smooth(method=lm, na.rm = TRUE,colour="black")+
  xlab("in_vitro_mean") + ylab("in_silico_prediction")+ ggtitle(paste0(cmb_df_temp$cell_type[i],"_",cmb_df_temp$sm_name[i]))+
  labs(tag = paste0("R2=",r2))+ theme(plot.tag.position = "topright")+
    xlim(0,2000) + ylim(0,2000)
  print(p)
}
```
